<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <title>è®°å•è¯ Â· æ——èˆ°è§¦å± Â· ç”Ÿè¯æœ¬/å‘éŸ³/éšè—</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /*========== å…¨å±€æ ·å¼ ========== æè‡´å®Œæ•´ç‰ˆ æ— ä»»ä½•åˆ å‡ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', 'PingFang SC', sans-serif;
        }

        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --accent-color: #f72585;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #6c757d;
            --success-color: #4cc9f0;
            --warning-color: #f8961e;
            --danger-color: #e63946;
            --familiar-color: #2a9d8f;
            --unfamiliar-color: #e76f51;
            --somewhat-color: #f8961e;
            --mastered-color: #4361ee;
            --collection-color: #9c89b8;
            --card-shadow: 0 15px 35px rgba(0, 0, 0, 0.05);
            --transition: all 0.25s cubic-bezier(0.2, 0.9, 0.4, 1);
            --border-radius-card: 28px;
            --border-radius-btn: 50px;
            --border-radius-sm: 16px;
        }

        body {
            background: linear-gradient(145deg, #edf2fb 0%, #e2eafc 100%);
            color: var(--dark-color);
            min-height: 100vh;
            padding: 18px 16px;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* å¤´éƒ¨ */
        header {
            text-align: center;
            margin-bottom: 32px;
            padding: 12px 8px;
            animation: fadeIn 0.7s ease;
        }

        h1 {
            color: var(--secondary-color);
            font-size: 2.6rem;
            margin-bottom: 8px;
            letter-spacing: 1.5px;
            text-shadow: 0 4px 8px rgba(58,12,163,0.08);
        }

        .subtitle {
            font-size: 1.18rem;
            color: var(--gray-color);
            font-weight: 400;
            position: relative;
            display: inline-block;
        }

        /* æœç´¢æ¡† */
        .search-container {
            position: relative;
            margin-bottom: 32px;
            animation: slideUp 0.6s;
        }

        .search-box {
            width: 100%;
            padding: 18px 24px;
            border-radius: 60px;
            border: none;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            font-size: 1.2rem;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            border: 2px solid rgba(255,255,255,0.5);
        }

            .search-box:focus {
                outline: none;
                box-shadow: 0 10px 25px rgba(67,97,238,0.2);
                border-color: var(--primary-color);
            }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-top: 12px;
            overflow: hidden;
            z-index: 100;
            max-height: 0;
            opacity: 0;
            transition: max-height 0.4s ease, opacity 0.3s ease;
        }

            .search-results.expanded {
                max-height: 80vh;
                opacity: 1;
            }

        .search-result-card {
            background: white;
            border-radius: 24px;
            padding: 24px;
            margin: 16px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.04);
        }

        /* æ¨¡å¼å¡ç‰‡ç½‘æ ¼ */
        .mode-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 26px;
            margin-bottom: 50px;
        }

        .mode-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: var(--border-radius-card);
            padding: 36px 20px 30px;
            text-align: center;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.5);
            animation: slideUp 0.6s;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

            .mode-card:hover {
                transform: translateY(-12px);
                box-shadow: 0 30px 45px rgba(67,97,238,0.15);
                border-color: var(--primary-color);
                background: white;
            }

        .mode-icon {
            font-size: 4.2rem;
            margin-bottom: 18px;
            color: var(--primary-color);
            transition: 0.2s;
        }

        .mode-card:nth-child(2) .mode-icon {
            color: var(--accent-color);
        }

        .mode-card:nth-child(3) .mode-icon {
            color: var(--familiar-color);
        }

        .mode-card:nth-child(4) .mode-icon {
            color: var(--collection-color);
        }

        .mode-card h2 {
            font-size: 1.9rem;
            margin-bottom: 14px;
            color: var(--dark-color);
            font-weight: 700;
        }

        .mode-card p {
            color: var(--gray-color);
            line-height: 1.6;
            margin-bottom: 28px;
            padding: 0 6px;
            font-size: 1rem;
        }

        .mode-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: var(--border-radius-btn);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 6px 14px rgba(67,97,238,0.25);
            width: fit-content;
        }

        .mode-card:nth-child(2) .mode-btn {
            background: var(--accent-color);
            box-shadow: 0 6px 14px rgba(247,37,133,0.25);
        }

        .mode-card:nth-child(3) .mode-btn {
            background: var(--familiar-color);
            box-shadow: 0 6px 14px rgba(42,157,143,0.25);
        }

        .mode-card:nth-child(4) .mode-btn {
            background: var(--collection-color);
            box-shadow: 0 6px 14px rgba(156,137,184,0.35);
        }

        .mode-btn:hover {
            transform: scale(1.06);
            filter: brightness(1.08);
        }

        /* å…¬å…±å¤´éƒ¨è¿”å› */
        .back-btn {
            background: var(--gray-color);
            color: white;
            border: none;
            padding: 12px 26px;
            border-radius: 50px;
            font-size: 1.05rem;
            cursor: pointer;
            transition: 0.25s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
            font-weight: 600;
        }

            .back-btn:hover {
                background: var(--dark-color);
                transform: translateX(-6px);
            }

        /* æ•™æå¡ç‰‡ */
        .textbooks-container, .units-container, .words-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .textbook-card, .unit-card {
            background: white;
            border-radius: 22px;
            padding: 26px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.02);
            transition: 0.25s;
            cursor: pointer;
            border-left: 7px solid var(--primary-color);
            border-top: 1px solid rgba(0,0,0,0.02);
        }

            .textbook-card:hover, .unit-card:hover {
                transform: translateY(-7px);
                box-shadow: 0 20px 30px rgba(67,97,238,0.1);
            }

        .unit-card {
            border-left-color: var(--accent-color);
        }

        /* å•è¯å¡ç‰‡é€šç”¨ (å«å‘éŸ³) */
        .word-card {
            background: white;
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 10px 22px rgba(0,0,0,0.04);
            transition: 0.2s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

            .word-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: radial-gradient(circle at center, rgba(67,97,238,0.1) 0%, transparent 70%);
                opacity: 0;
                transition: opacity 0.3s;
            }

            .word-card:hover::before {
                opacity: 1;
            }

            .word-card:hover {
                transform: scale(1.03);
                box-shadow: 0 15px 30px rgba(67,97,238,0.12);
            }

        .word-header {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
        }

        .word {
            font-size: 1.9rem;
            font-weight: 700;
            color: var(--primary-color);
            line-height: 1.2;
        }

        .pronounce-btn {
            background: rgba(67,97,238,0.08);
            border: none;
            border-radius: 40px;
            padding: 8px 16px;
            font-size: 1rem;
            color: var(--primary-color);
            cursor: pointer;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
        }

            .pronounce-btn:hover {
                background: var(--primary-color);
                color: white;
            }

        .word-source {
            background: var(--light-color);
            padding: 6px 16px;
            border-radius: 30px;
            font-size: 0.85rem;
            color: var(--gray-color);
        }

        .basic-meaning {
            font-size: 1.3rem;
            margin-bottom: 12px;
            color: var(--dark-color);
        }

        /* æ¼«æ¸¸æ ¸å¿ƒåŒº */
        .wander-info {
            background: white;
            border-radius: 28px;
            padding: 24px 28px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.02);
        }

        .wander-stats {
            display: flex;
            gap: 24px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary-color);
            line-height: 1;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--gray-color);
        }

        .wander-controls {
            display: flex;
            gap: 14px;
        }

        .control-btn {
            background: white;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 10px 22px;
            border-radius: 50px;
            font-weight: 600;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

            .control-btn:hover {
                background: var(--primary-color);
                color: white;
            }

        /* æ¼«æ¸¸å¡ç‰‡å®¹å™¨ */
        .wander-card-container {
            position: relative;
            height: 580px;
            margin-bottom: 40px;
            perspective: 1200px;
            touch-action: pan-y;
        }

        .wander-card {
            position: absolute;
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 36px;
            box-shadow: 0 30px 55px rgba(0,0,0,0.1);
            padding: 40px 30px;
            display: flex;
            flex-direction: column;
            transition: transform 0.4s cubic-bezier(0.15, 0.9, 0.3, 1.1), opacity 0.3s;
            cursor: grab;
            user-select: none;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            will-change: transform, opacity;
            border: 1px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(2px);
        }

            .wander-card:active {
                cursor: grabbing;
            }

        .wander-word {
            font-size: 3.8rem;
            font-weight: 800;
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 8px;
            line-height: 1.1;
        }

        .wander-source {
            font-size: 1.2rem;
            color: var(--accent-color);
            background: rgba(247,37,133,0.06);
            padding: 8px 24px;
            border-radius: 50px;
            display: inline-block;
            margin: 0 auto 10px;
        }

        .wander-meaning {
            font-size: 2rem;
            text-align: center;
            margin: 20px 0 25px;
            color: var(--dark-color);
            font-weight: 600;
        }

        /* æ ‡è®°æŒ‰é’® è¶…å¤§è§¦å±åŒº */
        .word-marking {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin: 20px 0 20px;
            flex-wrap: wrap;
            pointer-events: auto;
            z-index: 30;
        }

        .mark-btn {
            padding: 14px 26px;
            border-radius: 50px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-size: 1.05rem;
            box-shadow: 0 6px 12px rgba(0,0,0,0.06);
            pointer-events: auto !important;
            -webkit-tap-highlight-color: transparent;
        }

        .mark-unfamiliar {
            background: var(--unfamiliar-color);
        }

        .mark-somewhat {
            background: var(--somewhat-color);
        }

        .mark-familiar {
            background: var(--familiar-color);
        }

        .mark-mastered {
            background: var(--mastered-color);
        }

        .mark-btn:hover {
            transform: translateY(-4px);
            filter: brightness(1.06);
        }

        .mark-status {
            text-align: center;
            padding: 12px;
            border-radius: 40px;
            margin-top: 10px;
            font-weight: 600;
            background: #f1f5f9;
        }

        /* éšè—æ¨¡å¼ç±» */
        .hide-meaning .wander-meaning,
        .hide-meaning .basic-meaning,
        .hide-meaning .history-word-meaning,
        .hide-meaning .word-meaning-part {
            display: none !important;
        }

        .hide-word .wander-word,
        .hide-word .word,
        .hide-word .history-word {
            display: none !important;
        }

        /* è¿›åº¦ç‚¹ */
        .wander-progress {
            display: flex;
            justify-content: center;
            gap: 14px;
            margin: 20px 0 30px;
        }

        .progress-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #d1d5db;
            transition: 0.2s;
            cursor: pointer;
        }

            .progress-dot.active {
                background: var(--accent-color);
                transform: scale(1.4);
            }

        /* ========== å†å²è®°å½• å…¨æ–°è¶…ç¾UI ========== */
        .history-controls {
            background: white;
            border-radius: 30px;
            padding: 24px 28px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 0 4px 18px rgba(0,0,0,0.02);
        }

        .history-filters {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 22px;
            border-radius: 40px;
            border: 2px solid var(--gray-color);
            background: white;
            color: var(--gray-color);
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            font-size: 0.95rem;
        }

            .filter-btn.active {
                background: var(--primary-color);
                border-color: var(--primary-color);
                color: white;
            }

        .history-stats {
            background: white;
            border-radius: 30px;
            padding: 24px;
            margin-bottom: 30px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.02);
        }

        .history-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 16px;
        }

        .history-stat {
            background: linear-gradient(145deg, #f8fafc, #f1f5f9);
            padding: 20px;
            border-radius: 22px;
            text-align: center;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.02);
        }

        .history-stat-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--primary-color);
            margin-bottom: 4px;
        }

        .history-stat-label {
            color: var(--gray-color);
            font-size: 0.95rem;
            font-weight: 500;
        }

        /* å†å²å•è¯å¡ç‰‡ â€”â€”â€”â€” æè‡´ç¾å·¥ */
        .history-words-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(330px, 1fr));
            gap: 28px;
        }

        .history-word-card {
            background: white;
            border-radius: 28px;
            padding: 26px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.04);
            transition: 0.25s;
            border-left: 10px solid var(--gray-color);
            position: relative;
            backdrop-filter: blur(6px);
            display: flex;
            flex-direction: column;
            border-top: 1px solid rgba(255,255,255,0.6);
        }

            .history-word-card:hover {
                transform: translateY(-8px);
                box-shadow: 0 25px 40px rgba(67,97,238,0.08);
            }

            .history-word-card.unfamiliar {
                border-left-color: var(--unfamiliar-color);
            }

            .history-word-card.somewhat {
                border-left-color: var(--somewhat-color);
            }

            .history-word-card.familiar {
                border-left-color: var(--familiar-color);
            }

            .history-word-card.mastered {
                border-left-color: var(--mastered-color);
            }

            .history-word-card.selected {
                box-shadow: 0 0 0 4px var(--primary-color), 0 12px 28px rgba(0,0,0,0.1);
            }

        .history-word-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 14px;
            flex-wrap: wrap;
        }

        .history-word {
            font-size: 2.1rem;
            font-weight: 800;
            color: var(--primary-color);
            line-height: 1.1;
        }

        .history-status {
            padding: 6px 18px;
            border-radius: 60px;
            font-size: 0.9rem;
            font-weight: 700;
            color: white;
        }

        .status-badge-unfamiliar {
            background: var(--unfamiliar-color);
        }

        .status-badge-somewhat {
            background: var(--somewhat-color);
        }

        .status-badge-familiar {
            background: var(--familiar-color);
        }

        .status-badge-mastered {
            background: var(--mastered-color);
        }

        .history-word-source {
            background: #f1f5f9;
            padding: 6px 18px;
            border-radius: 40px;
            font-size: 0.85rem;
            color: #475569;
            display: inline-block;
            width: fit-content;
            margin-bottom: 12px;
        }

        .history-word-meaning {
            font-size: 1.4rem;
            margin: 10px 0 12px;
            color: #1e293b;
            font-weight: 600;
            border-left: 4px solid var(--primary-color);
            padding-left: 16px;
        }

        .history-word-details {
            background: #f8fafc;
            padding: 16px 18px;
            border-radius: 20px;
            color: #334155;
            font-size: 0.98rem;
            margin: 12px 0 6px;
            border: 1px solid #e2e8f0;
        }

        .history-word-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            border-top: 1px solid #e9eef3;
            padding-top: 16px;
        }

        .history-view-count {
            background: #f1f5f9;
            padding: 6px 18px;
            border-radius: 50px;
            font-size: 0.85rem;
            color: #475569;
        }

        .action-btn {
            border: none;
            background: transparent;
            color: #64748b;
            cursor: pointer;
            padding: 8px 18px;
            border-radius: 30px;
            transition: 0.2s;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

            .action-btn:hover {
                background: #e2e8f0;
                color: #0f172a;
            }

        /* æ‰¹é‡æ“ä½œæ¡ */
        .batch-actions {
            background: white;
            border-radius: 60px;
            padding: 14px 24px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 16px rgba(0,0,0,0.04);
            border: 1px solid #f1f5f9;
        }

        .selected-count {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .batch-btn {
            padding: 10px 22px;
            border-radius: 40px;
            border: none;
            background: #e2e8f0;
            font-weight: 600;
            cursor: pointer;
        }

        /* ========== ç”Ÿè¯æœ¬ä¸“ç”¨ ========== */
        .collection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            background: white;
            padding: 20px 28px;
            border-radius: 30px;
        }

        /* æ¨¡æ€æ¡†ç‚«é…·è®¾è®¡ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(8px);
        }

        .modal-content {
            background: white;
            border-radius: 48px;
            padding: 36px;
            max-width: 750px;
            width: 94%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 50px 80px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.3);
        }

            .modal-content h3 {
                font-size: 2.2rem;
                color: var(--secondary-color);
                margin-bottom: 24px;
            }

        .section-selector {
            display: flex;
            gap: 16px;
            margin-bottom: 30px;
        }

        .section-btn {
            padding: 12px 28px;
            border-radius: 60px;
            border: 2px solid var(--gray-color);
            background: white;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
        }

            .section-btn.active {
                background: var(--primary-color);
                border-color: var(--primary-color);
                color: white;
            }

        .word-checkbox-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 24px;
            padding: 14px;
            background: #fafcff;
        }

        .word-check-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #edf2f7;
        }

            .word-check-item label {
                margin-left: 14px;
                flex: 1;
                font-size: 1.1rem;
            }

        /* å­¦ä¹ çŠ¶æ€åå¸ */
        .learning-status {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: white;
            border-radius: 60px;
            padding: 16px 30px;
            box-shadow: 0 20px 35px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 14px;
            z-index: 3500;
            border-left: 6px solid var(--success-color);
            backdrop-filter: blur(10px);
        }

        /* å•è¯è¯¦æƒ…é¡µ */
        .word-detail-page {
            background: white;
            border-radius: 36px;
            padding: 40px;
            margin: 20px 0;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            display: none;
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .detail-word {
            font-size: 3.2rem;
            font-weight: 800;
            color: var(--primary-color);
            line-height: 1.1;
        }

        .detail-pronunciation {
            font-size: 1.4rem;
            color: var(--gray-color);
            margin-top: 8px;
        }

        .detail-about {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

            .detail-about:hover {
                background: var(--secondary-color);
            }

        .detail-section {
            margin-bottom: 30px;
        }

            .detail-section h4 {
                font-size: 1.4rem;
                color: var(--secondary-color);
                margin-bottom: 16px;
                padding-bottom: 8px;
                border-bottom: 2px solid #e2e8f0;
            }

        .detail-item {
            background: #f8fafc;
            padding: 12px 18px;
            border-radius: 16px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary-color);
        }

        /* æ¼«æ¸¸è®¾ç½®æ¨¡æ€æ¡† */
        .settings-section {
            margin-bottom: 30px;
            background: #f1f5f9;
            padding: 20px;
            border-radius: 28px;
        }

            .settings-section h3 {
                margin-bottom: 16px;
                display: flex;
                gap: 8px;
                color: var(--secondary-color);
            }

        .settings-row {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 16px;
        }

        .settings-label {
            flex: 1;
            font-size: 1.1rem;
        }

        .settings-input {
            flex: 1;
            padding: 10px 16px;
            border-radius: 20px;
            border: 1px solid #cbd5e1;
            font-size: 1rem;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .slider-value {
            min-width: 40px;
            font-weight: 700;
            color: var(--primary-color);
        }

        /* åŠ¨ç”» */
        @keyframes fadeIn {
            0% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            0% {
                opacity: 0;
                transform: translateY(30px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* å¡ç‰‡åŠ¨ç”» */
        .card-expand-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 4000;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 24px;
            transform-origin: center;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* å“åº”å¼å¾®è°ƒ */
        @media (max-width: 600px) {
            h1 {
                font-size: 2rem;
            }

            .wander-word {
                font-size: 2.8rem;
            }

            .wander-meaning {
                font-size: 1.6rem;
            }

            .mark-btn {
                padding: 12px 18px;
                font-size: 0.9rem;
            }

            .search-box {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ========== ä¸»é¡µ ========== -->
        <header id="main-header">
            <h1>ğŸ“˜ è§¦å±Â·å•è¯</h1>
            <p class="subtitle">æ»‘åŠ¨å­¦ä¹  Â· ç”Ÿè¯æœ¬ Â· å‘éŸ³ Â· éšè—ä¸­è‹±</p>
        </header>

        <!-- æœç´¢æ¡† -->
        <div class="search-container">
            <input type="text" id="global-search" class="search-box" placeholder="ğŸ” è¾“å…¥å•è¯æœç´¢...">
            <div class="search-results" id="search-results">
                <div class="search-result-card" id="search-result-content">
                    <!-- æœç´¢ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>

        <!-- äº”å¤§æ¨¡å¼å¡ç‰‡ -->
        <div class="mode-selection" id="mode-selection">
            <!-- å¡ç‰‡1: å•å…ƒæŸ¥è¯ -->
            <div class="mode-card" id="unit-mode-btn">
                <div class="mode-icon"><i class="fas fa-book-open"></i></div>
                <h2>æŒ‰å•å…ƒæŸ¥è¯</h2>
                <p>æ•™æå•å…ƒé¡ºåºå­¦ä¹  Â· éŸ³æ ‡å‘éŸ³ Â· è¿›åº¦è®°å¿†</p>
                <button class="mode-btn"><i class="fas fa-play"></i> å¼€å§‹å­¦ä¹ </button>
            </div>
            <!-- å¡ç‰‡2: å•è¯æ¼«æ¸¸ (æ ¸å¿ƒ) -->
            <div class="mode-card" id="wander-mode-btn">
                <div class="mode-icon"><i class="fas fa-random"></i></div>
                <h2>å•è¯æ¼«æ¸¸</h2>
                <p>æ™ºèƒ½æƒé‡ Â· æ»‘åŠ¨çˆ½æ„Ÿ Â· éšè—ä¸­è‹± Â· æ•°é‡å¯è°ƒ</p>
                <button class="mode-btn"><i class="fas fa-walking"></i> å¼€å§‹æ¼«æ¸¸</button>
            </div>
            <!-- å¡ç‰‡3: å†å²è®°å½•(æ–°UI) -->
            <div class="mode-card" id="history-mode-btn">
                <div class="mode-icon"><i class="fas fa-history"></i></div>
                <h2>å†å²è®°å½•</h2>
                <p>å­¦ä¹ è½¨è¿¹ Â· ç²¾ç¾å¡ç‰‡ Â· æ‰¹é‡ç®¡ç† Â· ç»Ÿè®¡</p>
                <button class="mode-btn"><i class="fas fa-list"></i> æŸ¥çœ‹å†å²</button>
            </div>
            <!-- å¡ç‰‡4: ç”Ÿè¯æœ¬ / è‡ªå®šä¹‰æ”¶è— (å…¨æ–°) -->
            <div class="mode-card custom-collection-card" id="custom-collection-btn">
                <div class="mode-icon"><i class="fas fa-star"></i></div>
                <h2>ğŸ“š ç”Ÿè¯æœ¬</h2>
                <p>ä»æ•™æ/å†å²å¤šé€‰æ·»åŠ ï¼Œè‡ªå»ºä¸“å±è¯åº“æ¼«æ¸¸</p>
                <button class="mode-btn" style="background: #9c89b8;"><i class="fas fa-layer-group"></i> ç¼–è¾‘ç”Ÿè¯æœ¬</button>
            </div>
        </div>

        <!-- ========== å•å…ƒæŸ¥è¯æ¨¡å¼ ========== -->
        <div class="unit-mode" id="unit-mode" style="display: none;">
            <button class="back-btn" id="unit-back-btn"><i class="fas fa-arrow-left"></i> è¿”å›ä¸»é¡µ</button>
            <h2 style="margin-bottom: 24px;">ğŸ“– é€‰æ‹©æ•™æ</h2>
            <div class="textbooks-container" id="textbooks-container"></div>
            <div id="units-container" style="display: none;">
                <h2 id="units-title" style="margin-bottom: 24px;"></h2>
                <div class="units-container" id="units-list"></div>
            </div>
            <div id="words-container" style="display: none;">
                <h2 id="words-title" style="margin-bottom: 24px;"></h2>
                <div class="words-container" id="words-list"></div>
            </div>
            <!-- å•è¯è¯¦æƒ…é¡µ -->
            <div class="word-detail-page" id="word-detail-page">
                <div class="detail-header">
                    <div>
                        <div class="detail-word" id="detail-word"></div>
                        <div class="detail-pronunciation" id="detail-pronunciation"></div>
                    </div>
                    <button class="detail-about" id="detail-about-btn"><i class="fas fa-info-circle"></i> å…³äº</button>
                </div>
                <div id="detail-content">
                    <!-- è¯¦æƒ…å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>

        <!-- ========== å•è¯æ¼«æ¸¸æ¨¡å¼ ========== æ»‘åŠ¨/å‘éŸ³/éšè—å…¨é›†æˆ -->
        <div class="wander-mode" id="wander-mode" style="display: none;">
            <button class="back-btn" id="wander-back-btn"><i class="fas fa-arrow-left"></i> è¿”å›ä¸»é¡µ</button>
            <div class="wander-info">
                <div>
                    <h2 style="margin-bottom: 6px;" id="wander-title">âœ¨ å•è¯æ¼«æ¸¸</h2>
                    <p id="wander-description" style="color: var(--gray-color);">å·¦å³æ»‘åŠ¨åˆ‡æ¢ï¼Œä¸‹æ»‘è¿”å›</p>
                </div>
                <div class="wander-stats">
                    <div class="stat"><div class="stat-value" id="current-card">1</div><div class="stat-label">å½“å‰</div></div>
                    <div class="stat"><div class="stat-value" id="total-card-count">20</div><div class="stat-label">æ€»æ•°</div></div>
                    <div class="stat"><div class="stat-value" id="learned-count">0</div><div class="stat-label">å·²æ ‡è®°</div></div>
                </div>
                <div class="wander-controls">
                    <button class="control-btn" id="shuffle-btn"><i class="fas fa-random"></i> æ–°è¯</button>
                    <button class="control-btn" id="settings-btn"><i class="fas fa-cog"></i> è®¾ç½®</button>
                </div>
            </div>
            <!-- å¡ç‰‡å®¹å™¨ -->
            <div class="wander-card-container" id="wander-card-container"></div>
            <div class="wander-progress" id="wander-progress"></div>
        </div>

        <!-- ========== å†å²è®°å½•æ¨¡å¼ ========== å…¨æ–°UIå…¨åŠŸèƒ½ -->
        <div class="history-mode" id="history-mode" style="display: none;">
            <button class="back-btn" id="history-back-btn"><i class="fas fa-arrow-left"></i> è¿”å›ä¸»é¡µ</button>
            <!-- æ‰¹é‡æ“ä½œæ  -->
            <div class="batch-actions" id="batch-actions" style="display: none;">
                <div class="selected-count" id="selected-count">å·²é€‰æ‹© 0 ä¸ªå•è¯</div>
                <div class="batch-buttons">
                    <button class="batch-btn" id="select-all-btn"><i class="fas fa-check-square"></i> å…¨é€‰</button>
                    <button class="batch-btn" id="select-none-btn"><i class="fas fa-square"></i> å…¨ä¸é€‰</button>
                    <button class="batch-btn batch-delete" id="batch-delete-btn"><i class="fas fa-trash"></i> æ‰¹é‡åˆ é™¤</button>
                </div>
            </div>
            <div class="history-controls">
                <h2 style="font-size: 1.9rem;">ğŸ“… å­¦ä¹ å†å²</h2>
                <div class="history-filters" id="history-filters">
                    <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
                    <button class="filter-btn" data-filter="unfamiliar">é™Œç”Ÿ</button>
                    <button class="filter-btn" data-filter="somewhat">æœ‰ç‚¹ç†Ÿ</button>
                    <button class="filter-btn" data-filter="familiar">ç†Ÿæ‚‰</button>
                    <button class="filter-btn" data-filter="mastered">æŒæ¡</button>
                </div>
            </div>
            <!-- ç»Ÿè®¡åŒº -->
            <div class="history-stats" id="history-stats"></div>
            <!-- å†å²å•è¯å¡ç‰‡ç½‘æ ¼ -->
            <div class="history-words-container" id="history-words-container"></div>
        </div>

        <!-- ========== ç”Ÿè¯æœ¬æ¨¡å¼ (è‡ªå®šä¹‰æ”¶è—) ========== -->
        <div class="wander-mode" id="collection-mode" style="display: none;">
            <button class="back-btn" id="collection-back-btn"><i class="fas fa-arrow-left"></i> è¿”å›ä¸»é¡µ</button>
            <div class="collection-header">
                <h2 style="font-size: 2rem; color: var(--collection-color);"><i class="fas fa-star"></i> æˆ‘çš„ç”Ÿè¯æœ¬</h2>
                <button class="control-btn" id="add-to-collection-btn" style="background: var(--collection-color); color: white; border: none;">
                    <i class="fas fa-plus-circle"></i> æ·»åŠ å•è¯
                </button>
            </div>
            <div style="background: white; border-radius: 28px; padding: 22px 28px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center;">
                <div><span style="font-weight: 700; font-size: 1.4rem;">ğŸ“¦ å½“å‰è¯åº“æ•°é‡</span> <strong id="collection-count" style="font-size: 2.2rem; color: var(--collection-color); margin-left: 12px;">0</strong></div>
                <div style="display: flex; gap: 16px;">
                    <button id="start-learn-collection" class="mode-btn" style="background: var(--collection-color);"><i class="fas fa-play"></i> æ¼«æ¸¸ç”Ÿè¯æœ¬</button>
                    <button id="clear-collection" class="mode-btn" style="background: var(--gray-color);"><i class="fas fa-trash-alt"></i> æ¸…ç©º</button>
                </div>
            </div>
            <!-- ç”Ÿè¯æœ¬å•è¯åˆ—è¡¨ -->
            <div class="history-words-container" id="collection-words-list"></div>
        </div>

        <!-- ========== æ¼«æ¸¸è®¾ç½®æ¨¡æ€æ¡†ï¼ˆå…¨åŠŸèƒ½ï¼‰ ========== -->
        <div id="wander-settings-modal" class="modal">
            <div class="modal-content">
                <h2 style="display: flex; gap: 12px;"><i class="fas fa-sliders-h"></i> æ¼«æ¸¸è®¾ç½®</h2>

                <!-- æ¯æ¬¡éšæœºå•è¯æ•°é‡ -->
                <div class="settings-section">
                    <h3><i class="fas fa-hashtag"></i> æ¯æ—¥å•è¯æ•°</h3>
                    <div class="settings-row">
                        <div class="slider-container">
                            <input type="range" id="wander-count-slider" min="5" max="50" value="20" class="settings-input" style="flex: 1;">
                            <span id="wander-count-value" class="slider-value">20</span>
                        </div>
                    </div>
                </div>

                <!-- éšè—ä¸­/è‹±æ–‡ -->
                <div class="settings-section">
                    <h3><i class="fas fa-eye-slash"></i> éšè—æ¨¡å¼</h3>
                    <div class="settings-row">
                        <label class="settings-label">
                            <input type="checkbox" id="hide-chinese-checkbox"> éšè—ä¸­æ–‡é‡Šä¹‰
                        </label>
                    </div>
                    <div class="settings-row">
                        <label class="settings-label">
                            <input type="checkbox" id="hide-english-checkbox"> éšè—è‹±æ–‡å•è¯
                        </label>
                    </div>
                </div>

                <!-- é˜²é‡å¤ -->
                <div class="settings-section">
                    <h3><i class="fas fa-repeat"></i> é˜²é‡å¤</h3>
                    <div class="settings-row">
                        <label class="settings-label">
                            <input type="checkbox" id="prevent-recent" checked> é¿å…æœ€è¿‘çœ‹è¿‡çš„å•è¯
                        </label>
                    </div>
                </div>

                <!-- æƒé‡æ»‘å— -->
                <div class="settings-section">
                    <h3><i class="fas fa-weight-hanging"></i> å‡ºç°æ¦‚ç‡æƒé‡</h3>
                    <div class="settings-row">
                        <div class="slider-container" style="width: 100%;">
                            <span>é™Œç”Ÿ</span>
                            <input type="range" id="slider-unfamiliar" min="10" max="70" value="50" class="settings-input" style="flex: 1;">
                            <span id="weight-unfamiliar" class="slider-value">50</span>%
                        </div>
                    </div>
                    <div class="settings-row">
                        <div class="slider-container" style="width: 100%;">
                            <span>æœ‰ç‚¹ç†Ÿ</span>
                            <input type="range" id="slider-somewhat" min="10" max="70" value="25" class="settings-input" style="flex: 1;">
                            <span id="weight-somewhat" class="slider-value">25</span>%
                        </div>
                    </div>
                    <div class="settings-row">
                        <div class="slider-container" style="width: 100%;">
                            <span>ç†Ÿæ‚‰</span>
                            <input type="range" id="slider-familiar" min="10" max="70" value="15" class="settings-input" style="flex: 1;">
                            <span id="weight-familiar" class="slider-value">15</span>%
                        </div>
                    </div>
                    <div class="settings-row">
                        <div class="slider-container" style="width: 100%;">
                            <span>æŒæ¡</span>
                            <input type="range" id="slider-mastered" min="10" max="70" value="10" class="settings-input" style="flex: 1;">
                            <span id="weight-mastered" class="slider-value">10</span>%
                        </div>
                    </div>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 20px;">
                    <button id="settings-cancel" class="control-btn" style="background: var(--gray-color); border: none;"><i class="fas fa-times"></i> å–æ¶ˆ</button>
                    <button id="settings-save" class="control-btn" style="background: var(--primary-color); border: none;"><i class="fas fa-save"></i> ä¿å­˜è®¾ç½®</button>
                </div>
            </div>
        </div>

        <!-- ========== æ·»åŠ ç”Ÿè¯æœ¬æ¨¡æ€æ¡†ï¼ˆå¤šé€‰æ•™æ/å†å²ï¼‰========= -->
        <div id="add-collection-modal" class="modal">
            <div class="modal-content">
                <h3 style="display: flex; gap: 12px;"><i class="fas fa-star" style="color: var(--collection-color);"></i> æ·»åŠ åˆ°ç”Ÿè¯æœ¬</h3>
                <!-- åˆ‡æ¢é€‰é¡¹å¡ -->
                <div class="section-selector">
                    <button class="section-btn active" id="tab-textbook">ğŸ“˜ ä»æ•™æé€‰æ‹©</button>
                    <button class="section-btn" id="tab-history">ğŸ“… ä»å†å²è®°å½•é€‰æ‹©</button>
                </div>
                <!-- æ•™æé€‰æ‹©åŒºåŸŸ -->
                <div id="textbook-select-area">
                    <p style="font-weight: 600; margin-bottom: 10px;">1. é€‰æ‹©æ•™æ</p>
                    <select id="select-textbook" style="width: 100%; padding: 14px; border-radius: 40px; border: 1px solid #ccc; margin-bottom: 18px;"></select>
                    <p style="font-weight: 600; margin-bottom: 10px;">2. é€‰æ‹©å•å…ƒ</p>
                    <select id="select-unit" style="width: 100%; padding: 14px; border-radius: 40px; border: 1px solid #ccc; margin-bottom: 20px;"></select>
                    <p style="font-weight: 600; margin-bottom: 12px;">3. å‹¾é€‰å•è¯ (å¤šé€‰)</p>
                    <div id="word-checkbox-list-container" class="word-checkbox-list"></div>
                </div>
                <!-- å†å²é€‰æ‹©åŒºåŸŸ -->
                <div id="history-select-area" style="display: none;">
                    <p style="font-weight: 600; margin-bottom: 16px;">ğŸ“Œ ä»å†å²è®°å½•é€‰æ‹©å•è¯ (å¤šé€‰)</p>
                    <div id="history-word-check-list" class="word-checkbox-list"></div>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 20px; margin-top: 32px;">
                    <button id="close-collection-modal" style="padding: 12px 28px; border: 2px solid #adb5bd; background: white; border-radius: 60px; font-weight: 600;">å–æ¶ˆ</button>
                    <button id="confirm-add-collection" style="padding: 12px 36px; background: var(--collection-color); color: white; border: none; border-radius: 60px; font-weight: 700;"><i class="fas fa-check"></i> ç¡®è®¤æ·»åŠ </button>
                </div>
            </div>
        </div>

        <!-- å…¨å±€å­¦ä¹ çŠ¶æ€æç¤º -->
        <div class="learning-status" id="learning-status" style="display: none;">
            <i class="fas fa-check-circle" style="color: #2a9d8f; font-size: 1.6rem;"></i>
            <span class="status-text" style="font-size: 1.1rem; font-weight: 500;"></span>
        </div>
    </div>

    <script>
        // ------------------------------------------------------------
        // ç¬¬ä¸€éƒ¨åˆ† JS: æ•°æ®å®šä¹‰ã€å…¨å±€å˜é‡ã€å·¥å…·å‡½æ•°ã€å­˜å‚¨ã€åˆå§‹åŒ–ç­‰
        // å®Œæ•´æ— åˆ å‡ï¼Œä¸HTMLå®Œç¾åµŒåˆ
        // ------------------------------------------------------------

        // ----- 1. å…¨å±€è¯æ±‡æ•°æ® -----
        let vocabularyData = [];

        // æ¨¡æ‹Ÿåå¤‡æ•°æ®ï¼ˆåŒ…å«pronunciationå­—æ®µï¼Œç¬¦åˆæ–°jsonç»“æ„ï¼‰
        function getFallbackData() {
            return [
                {
                    "name": "å¿…ä¿®ç¬¬ä¸€å†Œ",
                    "units": [
                        {
                            "name": "Welcome Unit",
                            "vocabulary": [
                                { "word": "exchange", "basic_meaning": "n. äº¤æ¢ï¼›äº¤æµ", "details": ["vt.äº¤æ¢ï¼›äº¤æµï¼›äº¤æ˜“ï¼›å…‘æ¢"], "pronunciation": "/ÉªksËˆtÊƒeÉªndÊ’/" },
                                { "word": "lecture", "basic_meaning": "n. è®²åº§ï¼›è®²è¯¾ï¼›æ•™è®­", "details": ["vi.ï¼ˆå¼€ï¼‰è®²åº§ï¼›è®²è¯¾", "vt.è®­æ–¥"], "pronunciation": "/ËˆlektÊƒÉ™(r)/" },
                                { "word": "slide", "basic_meaning": "v./n. æ»‘åŠ¨", "details": ["vi. æ»‘åŠ¨ï¼›æ»‘è½", "n. å¹»ç¯ç‰‡"], "pronunciation": "/slaÉªd/" },
                                { "word": "registration", "basic_meaning": "n. ç™»è®°ï¼›æ³¨å†Œï¼›æŒ‚å·", "details": [], "pronunciation": "/ËŒredÊ’ÉªËˆstreÉªÊƒÉ™n/" },
                                { "word": "register", "basic_meaning": "vt.&vi. ç™»è®°ï¼›æ³¨å†Œ", "details": [], "pronunciation": "/ËˆredÊ’ÉªstÉ™(r)/" },
                                { "word": "sex", "basic_meaning": "n. æ€§åˆ«", "details": [], "pronunciation": "/seks/" },
                                { "word": "female", "basic_meaning": "adj. å¥³ï¼ˆæ€§ï¼‰çš„ï¼Œé›Œçš„", "details": ["n. é›Œæ€§åŠ¨ï¼ˆæ¤ï¼‰ç‰©ï¼›å¥³å­"], "pronunciation": "/ËˆfiËmeÉªl/" },
                                { "word": "male", "basic_meaning": "adj. ç”·ï¼ˆæ€§ï¼‰çš„ï¼›é›„çš„", "details": ["n. é›„æ€§åŠ¨ï¼ˆæ¤ï¼‰ç‰©ï¼›ç”·å­"], "pronunciation": "/meÉªl/" },
                                { "word": "nationality", "basic_meaning": "n. å›½ç±ï¼›æ°‘æ—", "details": [], "pronunciation": "/nÃ¦ÊƒÉ™ËˆnÃ¦lÉ™tÉª/" }
                            ]
                        }
                    ]
                }
            ];
        }

        // å¼‚æ­¥åŠ è½½çœŸå®æ•°æ®ï¼ˆè‹¥å¤±è´¥åˆ™ä½¿ç”¨åå¤‡ï¼‰
        async function loadVocabularyData() {
            try {
                const response = await fetch('vocabulary_fixed.json');
                if (!response.ok) throw new Error('ç½‘ç»œé”™è¯¯');
                vocabularyData = await response.json();
                console.log('âœ… è¯æ±‡æ•°æ®åŠ è½½æˆåŠŸ:', vocabularyData.length, 'æœ¬æ•™æ');
            } catch (error) {
                console.warn('âš ï¸ åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å†…ç½®æ¼”ç¤ºæ•°æ®ï¼ˆå«å‘éŸ³ï¼‰');
                vocabularyData = getFallbackData();
            }
        }

        // ----- 2. çŠ¶æ€å˜é‡ -----
        let currentMode = 'home';              // home, unit, wander, history, collection
        let currentTextbook = null;
        let currentUnit = null;
        let currentWordDetail = null;          // å½“å‰æŸ¥çœ‹çš„å•è¯è¯¦æƒ…
        let fromCollectionWander = false;      // æ˜¯å¦ä»ç”Ÿè¯æœ¬å¼€å§‹çš„æ¼«æ¸¸

        // æ¼«æ¸¸å•è¯ç›¸å…³
        let wanderWords = [];
        let currentWanderIndex = 0;
        let recentWords = [];                 // æœ€è¿‘20ä¸ªå•è¯key

        // å•è¯æŒæ¡çŠ¶æ€å¸¸é‡
        const WORD_STATUS = {
            UNFAMILIAR: 'unfamiliar',
            SOMEWHAT: 'somewhat',
            FAMILIAR: 'familiar',
            MASTERED: 'mastered'
        };

        // ç”Ÿè¯æœ¬é›†åˆ (å­˜å‚¨wordKey)
        let collectionSet = new Set();

        // æ¼«æ¸¸è®¾ç½® (å®Œæ•´)
        let wanderSettings = {
            preventRecent: true,
            wanderCount: 20,
            hideChinese: false,
            hideEnglish: false,
            weights: {
                [WORD_STATUS.UNFAMILIAR]: 50,
                [WORD_STATUS.SOMEWHAT]: 25,
                [WORD_STATUS.FAMILIAR]: 15,
                [WORD_STATUS.MASTERED]: 10
            }
        };

        // å­¦ä¹ å†å²è®°å½• { wordKey : { status, viewCount, lastViewed, history[] } }
        let wordHistory = {};

        // æ‰¹é‡é€‰æ‹©é›†åˆï¼ˆå†å²è®°å½•é¡µé¢ï¼‰
        let selectedWords = new Set();

        // ----- 3. DOM å…ƒç´ ç¼“å­˜ -----
        const modeSelection = document.getElementById('mode-selection');
        const unitModeDiv = document.getElementById('unit-mode');
        const wanderModeDiv = document.getElementById('wander-mode');
        const historyModeDiv = document.getElementById('history-mode');
        const collectionModeDiv = document.getElementById('collection-mode');

        const textbooksContainer = document.getElementById('textbooks-container');
        const unitsContainer = document.getElementById('units-container');
        const unitsList = document.getElementById('units-list');
        const wordsContainer = document.getElementById('words-container');
        const wordsList = document.getElementById('words-list');

        const wanderCardContainer = document.getElementById('wander-card-container');
        const wanderProgress = document.getElementById('wander-progress');
        const currentCardElement = document.getElementById('current-card');
        const totalCardElement = document.getElementById('total-card-count');
        const learnedCountElement = document.getElementById('learned-count');

        const learningStatus = document.getElementById('learning-status');
        const statusText = document.querySelector('.learning-status .status-text');

        const batchActions = document.getElementById('batch-actions');
        const selectedCountSpan = document.getElementById('selected-count');

        // æœç´¢ç›¸å…³å…ƒç´ 
        const globalSearch = document.getElementById('global-search');
        const searchResults = document.getElementById('search-results');
        const searchResultContent = document.getElementById('search-result-content');

        // è¯¦æƒ…é¡µç›¸å…³å…ƒç´ 
        const wordDetailPage = document.getElementById('word-detail-page');
        const detailWord = document.getElementById('detail-word');
        const detailPronunciation = document.getElementById('detail-pronunciation');
        const detailContent = document.getElementById('detail-content');
        const detailAboutBtn = document.getElementById('detail-about-btn');

        // æ¼«æ¸¸æ§åˆ¶æŒ‰é’®
        const shuffleBtn = document.getElementById('shuffle-btn');
        const settingsBtn = document.getElementById('settings-btn');

        // ----- 4. å‘éŸ³å‡½æ•° (æœ‰é“API + å¤‡é€‰) -----
        function playPronunciation(word, accent = 'us') {
            if (!word) return;
            // æœ‰é“è¯å…¸API type=1 ç¾éŸ³, type=2 è‹±éŸ³
            const type = accent === 'uk' ? 2 : 1;
            const audioUrl = `https://dict.youdao.com/dictvoice?type=${type}&audio=${encodeURIComponent(word)}`;
            const audio = new Audio(audioUrl);
            audio.play().catch(err => {
                // å¤‡: è°·æ­Œè¯å…¸è‹±éŸ³
                const fallbackUrl = `https://ssl.gstatic.com/dictionary/static/sounds/oxford/${word}--_gb_1.mp3`;
                const fallbackAudio = new Audio(fallbackUrl);
                fallbackAudio.play().catch(e => {
                    console.warn('å‘éŸ³å¤±è´¥', e);
                    showLearningStatus('ğŸ”‡ æš‚æ—¶æ— æ³•å‘éŸ³');
                });
            });
            showLearningStatus(`ğŸ”Š æ’­æ”¾: ${word} (${accent === 'uk' ? 'è‹±å¼' : 'ç¾å¼'})`);
        }

        // æ”¹è¿›å‘éŸ³æŒ‰é’®ï¼šé•¿æŒ‰åˆ‡æ¢è‹±å¼ç¾å¼
        function setupPronounceButton(button, word) {
            let pressTimer = null;
            let accent = 'us'; // é»˜è®¤ç¾å¼

            button.addEventListener('mousedown', function () {
                pressTimer = setTimeout(() => {
                    accent = accent === 'us' ? 'uk' : 'us';
                    const accentText = accent === 'uk' ? 'è‹±å¼' : 'ç¾å¼';
                    showLearningStatus(`ğŸ”„ åˆ‡æ¢ä¸º${accentText}å‘éŸ³`);
                }, 500); // é•¿æŒ‰500msåˆ‡æ¢
            });

            button.addEventListener('mouseup', function () {
                if (pressTimer) {
                    clearTimeout(pressTimer);
                    pressTimer = null;
                }
                playPronunciation(word, accent);
            });

            button.addEventListener('mouseleave', function () {
                if (pressTimer) {
                    clearTimeout(pressTimer);
                    pressTimer = null;
                }
            });

            // è§¦æ‘¸è®¾å¤‡æ”¯æŒ
            button.addEventListener('touchstart', function (e) {
                pressTimer = setTimeout(() => {
                    accent = accent === 'us' ? 'uk' : 'us';
                    const accentText = accent === 'uk' ? 'è‹±å¼' : 'ç¾å¼';
                    showLearningStatus(`ğŸ”„ åˆ‡æ¢ä¸º${accentText}å‘éŸ³`);
                }, 500);
            });

            button.addEventListener('touchend', function (e) {
                if (pressTimer) {
                    clearTimeout(pressTimer);
                    pressTimer = null;
                }
                playPronunciation(word, accent);
            });
        }

        // ----- 5. é€šç”¨å·¥å…·å‡½æ•° -----
        // ç”Ÿæˆå•è¯å”¯ä¸€key
        function getWordKey(word, textbookName, unitName) {
            return `${textbookName}|${unitName}|${word.word}`;
        }

        // è·å–çŠ¶æ€ä¸­æ–‡
        function getStatusText(status) {
            const map = {
                [WORD_STATUS.UNFAMILIAR]: 'é™Œç”Ÿ',
                [WORD_STATUS.SOMEWHAT]: 'æœ‰ç‚¹ç†Ÿ',
                [WORD_STATUS.FAMILIAR]: 'ç†Ÿæ‚‰',
                [WORD_STATUS.MASTERED]: 'æŒæ¡'
            };
            return map[status] || 'æœªçŸ¥';
        }

        // çŸ­æš‚å­¦ä¹ æç¤º
        function showLearningStatus(msg) {
            if (!learningStatus || !statusText) return;
            statusText.textContent = msg;
            learningStatus.style.display = 'flex';
            clearTimeout(window.statusTimer);
            window.statusTimer = setTimeout(() => {
                learningStatus.style.display = 'none';
            }, 2000);
        }

        // è·å–å•è¯è¯¦ç»†ä¿¡æ¯ï¼ˆé€šè¿‡æœ‰é“APIï¼‰
        async function getWordDetails(word) {
            try {
                // ä½¿ç”¨æœ‰é“è¯å…¸APIè·å–è¯¦ç»†ä¿¡æ¯
                const url = `https://dict.youdao.com/jsonapi?q=${encodeURIComponent(word)}`;
                const response = await fetch(url);
                const data = await response.json();

                return data;
            } catch (error) {
                console.error('è·å–å•è¯è¯¦æƒ…å¤±è´¥:', error);
                return null;
            }
        }

        // æ ¼å¼åŒ–å•è¯è¯¦æƒ…æ˜¾ç¤º
        function formatWordDetails(data) {
            if (!data) return '<p>æœªèƒ½è·å–è¯¦ç»†ä¿¡æ¯</p>';

            let html = '';

            // åŸºæœ¬é‡Šä¹‰
            if (data.ec && data.ec.word) {
                const wordInfo = data.ec.word[0];
                html += `<div class="detail-section"><h4>åŸºæœ¬é‡Šä¹‰</h4>`;
                if (wordInfo.trs) {
                    wordInfo.trs.forEach(tr => {
                        html += `<div class="detail-item">${tr.pos} ${tr.tr[0].l.i[0]}</div>`;
                    });
                }
                html += `</div>`;
            }

            // ç½‘ç»œé‡Šä¹‰
            if (data.web_trans && data.web_trans.web) {
                html += `<div class="detail-section"><h4>ç½‘ç»œé‡Šä¹‰</h4>`;
                data.web_trans.web.forEach(item => {
                    html += `<div class="detail-item"><strong>${item.key}</strong>: ${item.trans.join('; ')}</div>`;
                });
                html += `</div>`;
            }

            // çŸ­è¯­
            if (data.phrs && data.phrs.phrs) {
                html += `<div class="detail-section"><h4>å¸¸ç”¨çŸ­è¯­</h4>`;
                data.phrs.phrs.forEach(phr => {
                    html += `<div class="detail-item"><strong>${phr.phr}</strong>: ${phr.translation}</div>`;
                });
                html += `</div>`;
            }

            // ä¾‹å¥
            if (data.blng_sents_part && data.blng_sents_part.sentence_part) {
                html += `<div class="detail-section"><h4>åŒè¯­ä¾‹å¥</h4>`;
                data.blng_sents_part.sentence_part.sentences.slice(0, 3).forEach(sent => {
                    html += `<div class="detail-item"><em>${sent.src}</em><br>${sent.trans}</div>`;
                });
                html += `</div>`;
            }

            return html || '<p>æ²¡æœ‰æ‰¾åˆ°è¯¦ç»†ä¿¡æ¯</p>';
        }

        // ----- 6. å­˜å‚¨æ“ä½œ -----
        function loadSettingsFromStorage() {
            const s = localStorage.getItem('wanderSettings');
            if (s) {
                try {
                    const parsed = JSON.parse(s);
                    wanderSettings = { ...wanderSettings, ...parsed };
                } catch (e) { }
            }
        }
        function saveSettingsToStorage() {
            localStorage.setItem('wanderSettings', JSON.stringify(wanderSettings));
        }

        function loadHistoryFromStorage() {
            const s = localStorage.getItem('wordHistory');
            if (s) {
                try {
                    wordHistory = JSON.parse(s);
                } catch (e) { }
            }
        }
        function saveHistoryToStorage() {
            localStorage.setItem('wordHistory', JSON.stringify(wordHistory));
        }

        function loadCollectionFromStorage() {
            const s = localStorage.getItem('collectionSet');
            if (s) {
                try {
                    collectionSet = new Set(JSON.parse(s));
                } catch (e) { }
            }
        }
        function saveCollectionToStorage() {
            localStorage.setItem('collectionSet', JSON.stringify(Array.from(collectionSet)));
        }

        // ------------------------------------------------------------

        // ========== 8. DOMContentLoaded å¯åŠ¨å™¨ ==========
        document.addEventListener('DOMContentLoaded', async function () {
            // åŠ è½½æ•°æ®
            await loadVocabularyData();

            // ----- ä¸»é¡µæ¨¡å¼å¡ç‰‡ç›‘å¬ -----
            document.getElementById('unit-mode-btn').addEventListener('click', showUnitMode);
            document.getElementById('wander-mode-btn').addEventListener('click', showWanderMode);
            document.getElementById('history-mode-btn').addEventListener('click', showHistoryMode);
            document.getElementById('custom-collection-btn').addEventListener('click', showCollectionMode);

            // ----- è¿”å›æŒ‰é’®ç›‘å¬ -----
            document.getElementById('unit-back-btn').addEventListener('click', showHomeMode);
            document.getElementById('wander-back-btn').addEventListener('click', showHomeMode);
            document.getElementById('history-back-btn').addEventListener('click', showHomeMode);
            document.getElementById('collection-back-btn').addEventListener('click', showHomeMode);

            // ----- æ¼«æ¸¸æ§åˆ¶ç›‘å¬ -----
            document.getElementById('shuffle-btn').addEventListener('click', generateWanderWords);
            document.getElementById('settings-btn').addEventListener('click', showWanderSettings);
            document.getElementById('settings-cancel').addEventListener('click', hideWanderSettings);
            document.getElementById('settings-save').addEventListener('click', saveWanderSettings);

            // ----- å†å²è®°å½•æ‰¹é‡ç›‘å¬ -----
            document.getElementById('select-all-btn').addEventListener('click', selectAllWords);
            document.getElementById('select-none-btn').addEventListener('click', selectNoneWords);
            document.getElementById('batch-delete-btn').addEventListener('click', batchDeleteWords);

            // ----- å†å²è¿‡æ»¤å™¨å§”æ‰˜ç›‘å¬ (åŠ¨æ€ç»‘å®š)-----
            const historyFilters = document.getElementById('history-filters');
            if (historyFilters) {
                historyFilters.addEventListener('click', function (e) {
                    if (e.target.classList.contains('filter-btn')) {
                        const filter = e.target.dataset.filter;
                        loadHistoryDisplay(filter);
                    }
                });
            }

            // ----- ç”Ÿè¯æœ¬ç›¸å…³ç›‘å¬ -----
            document.getElementById('add-to-collection-btn').addEventListener('click', showAddCollectionModal);
            document.getElementById('close-collection-modal').addEventListener('click', function () {
                document.getElementById('add-collection-modal').style.display = 'none';
            });
            document.getElementById('confirm-add-collection').addEventListener('click', addSelectedWordsToCollection);
            document.getElementById('tab-textbook').addEventListener('click', function () {
                switchCollectionTab('textbook');
            });
            document.getElementById('tab-history').addEventListener('click', function () {
                switchCollectionTab('history');
            });
            document.getElementById('start-learn-collection').addEventListener('click', startWanderFromCollection);
            document.getElementById('clear-collection').addEventListener('click', function () {
                if (confirm('ç¡®å®šæ¸…ç©ºæ•´ä¸ªç”Ÿè¯æœ¬å—ï¼Ÿ')) {
                    collectionSet.clear();
                    saveCollectionToStorage();
                    showCollectionWords();
                    showLearningStatus('ğŸ—‘ï¸ ç”Ÿè¯æœ¬å·²æ¸…ç©º');
                }
            });

            // ----- æ¼«æ¸¸è®¾ç½®æ»‘å—è”åŠ¨ -----
            ['unfamiliar', 'somewhat', 'familiar', 'mastered'].forEach(status => {
                const slider = document.getElementById(`slider-${status}`);
                const label = document.getElementById(`weight-${status}`);
                if (slider) {
                    slider.addEventListener('input', function () {
                        label.textContent = this.value;
                    });
                }
            });
            // å•è¯æ•°é‡æ»‘å—æ˜¾ç¤º
            const countSlider = document.getElementById('wander-count-slider');
            const countValue = document.getElementById('wander-count-value');
            if (countSlider) {
                countSlider.addEventListener('input', function () {
                    countValue.textContent = this.value;
                });
            }

            // ----- æ•™æ/å•å…ƒä¸‹æ‹‰è”åŠ¨ (ç”¨äºæ·»åŠ ç”Ÿè¯æœ¬) -----
            const selectTextbook = document.getElementById('select-textbook');
            if (selectTextbook) {
                selectTextbook.addEventListener('change', function () {
                    populateUnitDropdown();
                    populateWordCheckboxList();
                });
            }
            const selectUnit = document.getElementById('select-unit');
            if (selectUnit) {
                selectUnit.addEventListener('change', function () {
                    populateWordCheckboxList();
                });
            }

            // ----- æœç´¢æ¡†ç›‘å¬ -----
            globalSearch.addEventListener('focus', function () {
                if (this.value.trim() !== '') {
                    searchResults.classList.add('expanded');
                }
            });

            globalSearch.addEventListener('blur', function () {
                // å»¶è¿Ÿéšè—ï¼Œè®©ç”¨æˆ·èƒ½ç‚¹å‡»ç»“æœ
                setTimeout(() => {
                    searchResults.classList.remove('expanded');
                }, 200);
            });

            globalSearch.addEventListener('input', async function () {
                const query = this.value.trim();
                if (query) {
                    searchResults.classList.add('expanded');
                    await performGlobalSearch(query);
                } else {
                    searchResults.classList.remove('expanded');
                }
            });

            // ----- è¯¦æƒ…é¡µå…³äºæŒ‰é’®ç›‘å¬ -----
            if (detailAboutBtn) {
                detailAboutBtn.addEventListener('click', async function () {
                    if (currentWordDetail) {
                        const details = await getWordDetails(currentWordDetail.word.word);
                        if (details) {
                            detailContent.innerHTML = formatWordDetails(details);
                        } else {
                            detailContent.innerHTML = '<p>æœªèƒ½è·å–è¯¦ç»†ä¿¡æ¯</p>';
                        }
                    }
                });
            }

            // ----- ä»å­˜å‚¨åŠ è½½è®¾ç½®ã€å†å²ã€ç”Ÿè¯æœ¬ -----
            loadSettingsFromStorage();
            loadHistoryFromStorage();
            loadCollectionFromStorage();

            // ----- åˆå§‹åŒ–æ•™æåˆ—è¡¨ï¼ˆå•å…ƒæŸ¥è¯ï¼‰-----
            initializeTextbooks();

            // é»˜è®¤æ˜¾ç¤ºä¸»é¡µ
            showHomeMode();
        });

        // ========== 9. æ¨¡å¼åˆ‡æ¢å‡½æ•° ==========
        function showHomeMode() {
            currentMode = 'home';
            modeSelection.style.display = 'grid';
            unitModeDiv.style.display = 'none';
            wanderModeDiv.style.display = 'none';
            historyModeDiv.style.display = 'none';
            collectionModeDiv.style.display = 'none';
            // é‡ç½®å•å…ƒæŸ¥è¯æ˜¾ç¤ºçŠ¶æ€
            if (textbooksContainer) textbooksContainer.style.display = 'grid';
            if (unitsContainer) unitsContainer.style.display = 'none';
            if (wordsContainer) wordsContainer.style.display = 'none';
            if (wordDetailPage) wordDetailPage.style.display = 'none';

            // é‡ç½®æ¼«æ¸¸çŠ¶æ€
            fromCollectionWander = false;
            if (shuffleBtn) shuffleBtn.style.display = 'inline-flex';
            if (settingsBtn) settingsBtn.style.display = 'inline-flex';
            if (document.getElementById('wander-title')) document.getElementById('wander-title').textContent = 'âœ¨ å•è¯æ¼«æ¸¸';
        }

        function showUnitMode() {
            currentMode = 'unit';
            modeSelection.style.display = 'none';
            unitModeDiv.style.display = 'block';
            wanderModeDiv.style.display = 'none';
            historyModeDiv.style.display = 'none';
            collectionModeDiv.style.display = 'none';
            initializeTextbooks(); // åˆ·æ–°åˆ—è¡¨
        }

        function showWanderMode() {
            currentMode = 'wander';
            modeSelection.style.display = 'none';
            unitModeDiv.style.display = 'none';
            wanderModeDiv.style.display = 'block';
            historyModeDiv.style.display = 'none';
            collectionModeDiv.style.display = 'none';
            fromCollectionWander = false; // ä»ä¸»é¡µè¿›å…¥ï¼Œä¸æ˜¯ä»ç”Ÿè¯æœ¬
            if (shuffleBtn) shuffleBtn.style.display = 'inline-flex';
            if (settingsBtn) settingsBtn.style.display = 'inline-flex';
            if (document.getElementById('wander-title')) document.getElementById('wander-title').textContent = 'âœ¨ å•è¯æ¼«æ¸¸';
            generateWanderWords();  // ç”Ÿæˆæ¼«æ¸¸å•è¯
        }

        function showHistoryMode() {
            currentMode = 'history';
            modeSelection.style.display = 'none';
            unitModeDiv.style.display = 'none';
            wanderModeDiv.style.display = 'none';
            historyModeDiv.style.display = 'block';
            collectionModeDiv.style.display = 'none';
            selectedWords.clear();
            if (batchActions) batchActions.style.display = 'none';
            loadHistoryDisplay('all');
        }

        function showCollectionMode() {
            currentMode = 'collection';
            modeSelection.style.display = 'none';
            unitModeDiv.style.display = 'none';
            wanderModeDiv.style.display = 'none';
            historyModeDiv.style.display = 'none';
            collectionModeDiv.style.display = 'block';
            showCollectionWords();
        }

        // ========== 10. æœç´¢åŠŸèƒ½ ==========
        async function performGlobalSearch(query) {
            // é¦–å…ˆåœ¨æœ¬åœ°è¯æ±‡ä¸­æœç´¢
            const results = [];
            vocabularyData.forEach(textbook => {
                textbook.units.forEach(unit => {
                    unit.vocabulary.forEach(wordObj => {
                        if (wordObj.word.toLowerCase().includes(query.toLowerCase()) ||
                            (wordObj.basic_meaning && wordObj.basic_meaning.toLowerCase().includes(query.toLowerCase()))) {
                            results.push({
                                word: wordObj,
                                textbook: textbook.name,
                                unit: unit.name
                            });
                        }
                    });
                });
            });

            // æ˜¾ç¤ºæœ¬åœ°æœç´¢ç»“æœ
            if (results.length > 0) {
                let html = '<div class="detail-header"><div class="detail-word">æœç´¢ç»“æœ: "' + query + '"</div></div>';
                html += '<div class="history-words-container">';
                results.slice(0, 10).forEach(result => { // é™åˆ¶æ˜¾ç¤ºå‰10ä¸ª
                    html += `
                                        <div class="history-word-card" style="cursor:pointer;" onclick="showWordDetail('${result.textbook}', '${result.unit}', ${JSON.stringify(result.word).replace(/'/g, '&quot;')})">
                                            <div class="history-word">${result.word.word}</div>
                                            <div class="history-word-source">${result.textbook} Â· ${result.unit}</div>
                                            <div class="history-word-meaning">${result.word.basic_meaning || ''}</div>
                                        </div>
                                    `;
                });
                html += '</div>';
                searchResultContent.innerHTML = html;
            } else {
                // å¦‚æœæœ¬åœ°æ²¡æœ‰ç»“æœï¼Œå°è¯•ä½¿ç”¨æœ‰é“API
                try {
                    const apiResponse = await fetch(`https://dict.youdao.com/jsonapi?q=${encodeURIComponent(query)}`);
                    const data = await apiResponse.json();

                    if (data.ec && data.ec.word) {
                        const wordInfo = data.ec.word[0];
                        searchResultContent.innerHTML = `
                                            <div class="detail-header">
                                                <div>
                                                    <div class="detail-word">${wordInfo.word[0]}</div>
                                                    <div class="detail-pronunciation">${wordInfo.phonetic ? `[${wordInfo.phonetic}]` : ''}</div>
                                                </div>
                                                <button class="pronounce-btn" onclick="playPronunciation('${wordInfo.word[0]}')"><i class="fas fa-volume-up"></i> å‘éŸ³</button>
                                            </div>
                                            <div class="detail-section">
                                                <h4>é‡Šä¹‰</h4>
                                                ${wordInfo.trs ? wordInfo.trs.map(tr => `<div class="detail-item">${tr.pos} ${tr.tr[0].l.i[0]}</div>`).join('') : 'æ— é‡Šä¹‰'}
                                            </div>
                                        `;
                    } else {
                        searchResultContent.innerHTML = '<p>æœªæ‰¾åˆ°ç›¸å…³ç»“æœ</p>';
                    }
                } catch (error) {
                    searchResultContent.innerHTML = '<p>æœç´¢æœåŠ¡æš‚æ—¶ä¸å¯ç”¨</p>';
                }
            }
        }

        // ========== 11. å•å…ƒæŸ¥è¯å®Œæ•´åŠŸèƒ½ ==========
        function initializeTextbooks() {
            if (!textbooksContainer) return;
            textbooksContainer.innerHTML = '';
            vocabularyData.forEach((textbook) => {
                const unitCount = textbook.units.length;
                const totalWords = textbook.units.reduce((sum, u) => sum + u.vocabulary.length, 0);
                const card = document.createElement('div');
                card.className = 'textbook-card';
                card.innerHTML = `<h3>${textbook.name}</h3><p>åŒ…å« ${unitCount} ä¸ªå•å…ƒï¼Œå…± ${totalWords} ä¸ªå•è¯</p><span class="unit-count" style="background:var(--light-color); padding:6px 18px; border-radius:30px;">${unitCount} å•å…ƒ</span>`;
                card.addEventListener('click', () => showUnits(textbook));
                textbooksContainer.appendChild(card);
            });
        }

        function showUnits(textbook) {
            currentTextbook = textbook;
            textbooksContainer.style.display = 'none';
            unitsContainer.style.display = 'block';
            wordsContainer.style.display = 'none';
            document.getElementById('units-title').textContent = `${textbook.name} - å•å…ƒåˆ—è¡¨`;
            unitsList.innerHTML = '';
            textbook.units.forEach((unit) => {
                const card = document.createElement('div');
                card.className = 'unit-card';
                card.innerHTML = `<h4>${unit.name}</h4><p>${unit.vocabulary.length} ä¸ªå•è¯</p><span class="word-count" style="background:var(--success-color); color:white; padding:4px 16px; border-radius:30px;">${unit.vocabulary.length} è¯</span>`;
                card.addEventListener('click', () => showWords(unit, textbook.name));
                unitsList.appendChild(card);
            });
        }

        function showWords(unit, textbookName) {
            currentUnit = unit;
            unitsContainer.style.display = 'none';
            wordsContainer.style.display = 'block';
            document.getElementById('words-title').textContent = `${textbookName} - ${unit.name}`;
            wordsList.innerHTML = '';
            unit.vocabulary.forEach((word) => {
                const wordKey = getWordKey(word, textbookName, unit.name);
                const history = wordHistory[wordKey];
                const status = history ? history.status : WORD_STATUS.UNFAMILIAR;
                const card = document.createElement('div');
                card.className = 'word-card';

                // å‘éŸ³æŒ‰é’®
                const pronBtn = document.createElement('button');
                pronBtn.className = 'pronounce-btn';
                pronBtn.innerHTML = `<i class="fas fa-volume-up"></i> å‘éŸ³ ${word.pronunciation || ''}`;
                setupPronounceButton(pronBtn, word.word); // ä½¿ç”¨æ”¹è¿›çš„å‘éŸ³æŒ‰é’®

                const wordHeader = document.createElement('div');
                wordHeader.className = 'word-header';
                wordHeader.innerHTML = `<div class="word">${word.word}</div>`;
                wordHeader.appendChild(pronBtn);
                wordHeader.innerHTML += `<div class="word-source">${textbookName} Â· ${unit.name}</div>`;

                let detailsHTML = '';
                if (word.details && word.details.length) {
                    detailsHTML = `<div class="details" style="margin-top:16px;"><h5 style="color:var(--gray-color);">è¯¦ç»†é‡Šä¹‰ï¼š</h5>${word.details.map(d => `<div class="detail-item" style="background:var(--light-color); padding:10px; border-radius:12px; margin-bottom:6px;">${d}</div>`).join('')}</div>`;
                }

                let statusHTML = '';
                if (history) {
                    statusHTML = `<div class="mark-status status-${status}" style="margin-top:14px;">å½“å‰çŠ¶æ€ï¼š${getStatusText(status)} (æŸ¥çœ‹ ${history.viewCount || 0} æ¬¡)</div>`;
                }

                card.appendChild(wordHeader);
                const meaningDiv = document.createElement('div');
                meaningDiv.className = 'basic-meaning';
                meaningDiv.textContent = word.basic_meaning || '';
                card.appendChild(meaningDiv);
                if (statusHTML) card.insertAdjacentHTML('beforeend', statusHTML);
                if (detailsHTML) card.insertAdjacentHTML('beforeend', detailsHTML);

                // æ·»åŠ ç‚¹å‡»äº‹ä»¶è¿›å…¥è¯¦æƒ…é¡µ
                card.addEventListener('click', () => {
                    showWordDetail(textbookName, unit.name, word);
                });

                wordsList.appendChild(card);
            });
        }

        // æ˜¾ç¤ºå•è¯è¯¦æƒ…é¡µ
        function showWordDetail(textbookName, unitName, word) {
            currentWordDetail = { textbook: textbookName, unit: unitName, word: word };
            wordsContainer.style.display = 'none';
            wordDetailPage.style.display = 'block';

            detailWord.textContent = word.word;
            detailPronunciation.textContent = word.pronunciation ? `[${word.pronunciation}]` : '';

            // å¡«å……åŸºæœ¬ä¿¡æ¯
            detailContent.innerHTML = `
                                <div class="detail-section">
                                    <h4>åŸºæœ¬é‡Šä¹‰</h4>
                                    <div class="detail-item">${word.basic_meaning || 'æ— é‡Šä¹‰'}</div>
                                </div>
                                ${word.details && word.details.length ? `
                                <div class="detail-section">
                                    <h4>è¯¦ç»†é‡Šä¹‰</h4>
                                    ${word.details.map(d => `<div class="detail-item">${d}</div>`).join('')}
                                </div>` : ''}
                                <div class="detail-section">
                                    <h4>æ¥æº</h4>
                                    <div class="detail-item">${textbookName} Â· ${unitName}</div>
                                </div>
                            `;
        }

        // ä»è¯¦æƒ…é¡µè¿”å›å•è¯åˆ—è¡¨
        function backToWordsList() {
            if (currentUnit && currentTextbook) {
                showWords(currentUnit, currentTextbook.name);
            }
        }

        // ========== 12. æ¼«æ¸¸æ ¸å¿ƒå¼•æ“ (å«æƒé‡é€‰æ‹©ã€æ»‘åŠ¨ã€éšè—ã€å‘éŸ³) ==========
        function generateWanderWords() {
            const allWords = [];
            // åˆ¤æ–­æ˜¯å¦ä»ç”Ÿè¯æœ¬æ¼«æ¸¸
            let sourceCollection = fromCollectionWander && collectionSet.size > 0;

            vocabularyData.forEach(textbook => {
                textbook.units.forEach(unit => {
                    unit.vocabulary.forEach(word => {
                        const key = getWordKey(word, textbook.name, unit.name);
                        // å¦‚æœæ˜¯ä»ç”Ÿè¯æœ¬æ¨¡å¼ä¸”è¯¥å•è¯ä¸åœ¨collectionSetä¸­ï¼Œè·³è¿‡
                        if (sourceCollection && !collectionSet.has(key)) return;

                        const history = wordHistory[key];
                        const status = history ? history.status : WORD_STATUS.UNFAMILIAR;
                        allWords.push({
                            ...word,
                            textbook: textbook.name,
                            unit: unit.name,
                            key: key,
                            status: status,
                            weight: wanderSettings.weights[status] || 10
                        });
                    });
                });
            });

            if (allWords.length === 0) {
                showLearningStatus('ğŸ“­ è¯åº“ä¸ºç©ºï¼Œæ— æ³•æ¼«æ¸¸');
                wanderWords = [];
                createWanderCards();
                return;
            }

            let availableWords = [...allWords];
            if (wanderSettings.preventRecent && recentWords.length > 0) {
                availableWords = availableWords.filter(w => !recentWords.includes(w.key));
                if (availableWords.length < wanderSettings.wanderCount) {
                    availableWords = [...allWords]; // ä¸è¶³åˆ™å¿½ç•¥é˜²é‡å¤
                    showLearningStatus('âš ï¸ å¯ç”¨è¯è¾ƒå°‘ï¼Œå·²ä¸´æ—¶å…³é—­é˜²é‡å¤');
                }
            }

            // æƒé‡éšæœºé€‰æ‹©
            wanderWords = weightedRandomSelection(availableWords, wanderSettings.wanderCount);
            // æ›´æ–°æœ€è¿‘åˆ—è¡¨
            recentWords = wanderWords.map(w => w.key);
            if (recentWords.length > 30) recentWords = recentWords.slice(-30);

            currentWanderIndex = 0;
            if (totalCardElement) totalCardElement.textContent = wanderWords.length;
            createWanderCards();
            updateWanderProgress();
            updateLearnedCount();
        }

        function weightedRandomSelection(words, count) {
            if (words.length <= count) return words.slice(0, count);
            const selected = [];
            const pool = [...words];
            while (selected.length < count && pool.length > 0) {
                const totalWeight = pool.reduce((sum, w) => sum + (w.weight || 10), 0);
                let rand = Math.random() * totalWeight;
                for (let i = 0; i < pool.length; i++) {
                    rand -= (pool[i].weight || 10);
                    if (rand <= 0) {
                        selected.push(pool[i]);
                        pool.splice(i, 1);
                        break;
                    }
                }
            }
            return selected;
        }

        function createWanderCards() {
            if (!wanderCardContainer) return;
            wanderCardContainer.innerHTML = '';

            wanderWords.forEach((word, idx) => {
                const card = document.createElement('div');
                card.className = 'wander-card';
                card.dataset.index = idx;
                card.dataset.wordKey = word.key;

                card.style.opacity = idx === currentWanderIndex ? '1' : '0';
                card.style.zIndex = idx === currentWanderIndex ? '10' : '1';
                card.style.transform = 'translate(0,0) rotate(0deg)';
                card.style.transition = 'opacity 0.35s, transform 0.4s cubic-bezier(0.15,0.9,0.3,1.1)';

                // åº”ç”¨éšè—è®¾ç½®
                if (wanderSettings.hideChinese) card.classList.add('hide-meaning');
                if (wanderSettings.hideEnglish) card.classList.add('hide-word');

                const history = wordHistory[word.key];
                const status = history ? history.status : WORD_STATUS.UNFAMILIAR;
                const statusText = getStatusText(status);

                // å‘éŸ³æŒ‰é’®
                const pronBtn = `<button class="pronounce-btn wander-pronounce" style="margin:0 auto 10px;" data-word="${word.word}"><i class="fas fa-volume-up"></i> å‘éŸ³ ${word.pronunciation || ''}</button>`;

                let detailsHTML = '';
                if (word.details && word.details.length) {
                    detailsHTML = `<div class="wander-details" style="background:#f8fafc; border-radius:24px; padding:18px; margin-top:12px;">${word.details.map(d => `<div style="padding:6px 0; border-bottom:1px solid #e2e8f0;">${d}</div>`).join('')}</div>`;
                }

                card.innerHTML = `
                                    <div class="wander-card-header" style="text-align:center;">
                                        <div class="wander-word">${word.word}</div>
                                        ${pronBtn}
                                        <div class="wander-source">${word.textbook} Â· ${word.unit}</div>
                                    </div>
                                    <div class="wander-meaning">${word.basic_meaning || ''}</div>
                                    <div class="word-marking">
                                        <button class="mark-btn mark-unfamiliar" data-status="${WORD_STATUS.UNFAMILIAR}"><i class="fas fa-question-circle"></i> é™Œç”Ÿ</button>
                                        <button class="mark-btn mark-somewhat" data-status="${WORD_STATUS.SOMEWHAT}"><i class="fas fa-meh"></i> æœ‰ç‚¹ç†Ÿ</button>
                                        <button class="mark-btn mark-familiar" data-status="${WORD_STATUS.FAMILIAR}"><i class="fas fa-smile"></i> ç†Ÿæ‚‰</button>
                                        <button class="mark-btn mark-mastered" data-status="${WORD_STATUS.MASTERED}"><i class="fas fa-star"></i> æŒæ¡</button>
                                    </div>
                                    <div class="mark-status status-${status}">å½“å‰çŠ¶æ€ï¼š${statusText} ${history ? `(æŸ¥çœ‹ ${history.viewCount || 0} æ¬¡)` : ''}</div>
                                    ${detailsHTML}
                                `;

                // è®¾ç½®å‘éŸ³æŒ‰é’®
                const pronBtnEl = card.querySelector('.wander-pronounce');
                if (pronBtnEl) {
                    setupPronounceButton(pronBtnEl, word.word); // ä½¿ç”¨æ”¹è¿›çš„å‘éŸ³æŒ‰é’®
                }

                // æ ‡è®°æŒ‰é’®äº‹ä»¶
                card.querySelectorAll('.mark-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        const newStatus = btn.dataset.status;
                        markWordAs(word.key, newStatus);

                        // æ›´æ–°å½“å‰å¡ç‰‡çš„çŠ¶æ€æ˜¾ç¤º
                        const statusDiv = card.querySelector('.mark-status');
                        if (statusDiv) {
                            statusDiv.className = `mark-status status-${newStatus}`;
                            statusDiv.textContent = `å½“å‰çŠ¶æ€ï¼š${getStatusText(newStatus)} ${history ? `(æŸ¥çœ‹ ${history.viewCount || 0} æ¬¡)` : ''}`;
                        }
                    });
                    btn.addEventListener('touchstart', (e) => e.stopPropagation(), { passive: false });
                });

                // è®°å½•æŸ¥çœ‹æ¬¡æ•°
                recordWordView(word.key);

                // ç»‘å®šæ»‘åŠ¨ç›‘å¬
                attachSwipeListeners(card, idx);

                wanderCardContainer.appendChild(card);
            });
            if (currentCardElement) currentCardElement.textContent = currentWanderIndex + 1;
        }

        // æ»‘åŠ¨ç›‘å¬ï¼ˆå¢å¼ºè§¦å±ç‰ˆï¼‰
        function attachSwipeListeners(card, cardIndex) {
            let startX = 0, startY = 0, isDragging = false, offsetX = 0, offsetY = 0;

            function onStart(e) {
                if (cardIndex !== currentWanderIndex) return;
                e.stopPropagation();
                const touch = e.touches ? e.touches[0] : e;
                startX = touch.clientX;
                startY = touch.clientY;
                isDragging = true;
                card.style.transition = 'none';
            }

            function onMove(e) {
                if (!isDragging || cardIndex !== currentWanderIndex) return;
                e.preventDefault();
                e.stopPropagation();
                const touch = e.touches ? e.touches[0] : e;
                offsetX = touch.clientX - startX;
                offsetY = touch.clientY - startY;
                card.style.transform = `translate(${offsetX}px, ${offsetY}px) rotate(${offsetX * 0.08}deg)`;
                card.style.opacity = 1 - Math.min(Math.abs(offsetX) / 600, 0.4);
            }

            function onEnd(e) {
                if (!isDragging || cardIndex !== currentWanderIndex) return;
                isDragging = false;
                card.style.transition = 'transform 0.4s, opacity 0.3s';

                const absX = Math.abs(offsetX);
                const absY = Math.abs(offsetY);
                const threshold = 70;

                if (absX > absY && absX > threshold) {
                    if (offsetX > 0) {
                        goPrevCard();  // å³æ»‘ï¼šä¸Šä¸€ä¸ª
                    } else {
                        goNextCard();  // å·¦æ»‘ï¼šä¸‹ä¸€ä¸ª
                    }
                    const flyX = offsetX > 0 ? 450 : -450;
                    card.style.transform = `translate(${flyX}px, ${offsetY}px) rotate(${offsetX * 0.2}deg)`;
                    card.style.opacity = '0';
                } else if (absY > absX && absY > threshold) {
                    if (offsetY < 0) {
                        goNextCard();  // ä¸Šæ»‘ï¼šä¸‹ä¸€ä¸ª
                    } else {
                        goPrevCard();  // ä¸‹æ»‘ï¼šä¸Šä¸€ä¸ª
                    }
                    const flyY = offsetY > 0 ? 350 : -350;
                    card.style.transform = `translate(${offsetX}px, ${flyY}px) rotate(${offsetX * 0.1}deg)`;
                    card.style.opacity = '0';
                } else {
                    // å›å¼¹
                    card.style.transform = 'translate(0,0) rotate(0deg)';
                    card.style.opacity = '1';
                }
                offsetX = 0; offsetY = 0;

                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('touchmove', onMove);
                document.removeEventListener('mouseup', onEnd);
                document.removeEventListener('touchend', onEnd);
            }

            card.addEventListener('mousedown', onStart);
            card.addEventListener('touchstart', onStart, { passive: false });

            const attachGlobal = function () {
                document.addEventListener('mousemove', onMove);
                document.addEventListener('touchmove', onMove, { passive: false });
                document.addEventListener('mouseup', onEnd);
                document.addEventListener('touchend', onEnd);
            };

            // é‡æ–°åŒ…è£…ä»¥ä¿è¯å…¨å±€ç›‘å¬æ³¨å†Œ
            card.addEventListener('mousedown', function (e) { onStart(e); attachGlobal(); });
            card.addEventListener('touchstart', function (e) { onStart(e); attachGlobal(); }, { passive: false });
        }

        function goNextCard() {
            if (wanderWords.length === 0) return;
            if (currentWanderIndex < wanderWords.length - 1) {
                currentWanderIndex++;
            } else {
                currentWanderIndex = 0;
            }
            refreshCardsVisibility();
        }

        function goPrevCard() {
            if (wanderWords.length === 0) return;
            if (currentWanderIndex > 0) {
                currentWanderIndex--;
            } else {
                currentWanderIndex = wanderWords.length - 1;
            }
            refreshCardsVisibility();
        }

        function refreshCardsVisibility() {
            const cards = document.querySelectorAll('.wander-card');
            cards.forEach((card, idx) => {
                card.style.transition = 'opacity 0.35s, transform 0.4s';
                if (idx === currentWanderIndex) {
                    card.style.opacity = '1';
                    card.style.zIndex = '10';
                    card.style.transform = 'translate(0,0) rotate(0deg)';
                } else {
                    card.style.opacity = '0';
                    card.style.zIndex = '1';
                    card.style.transform = 'translate(0,0) rotate(0deg)';
                }
            });
            if (currentCardElement) currentCardElement.textContent = currentWanderIndex + 1;
            updateWanderProgress();
            updateLearnedCount();
        }

        function updateWanderProgress() {
            if (!wanderProgress) return;
            wanderProgress.innerHTML = '';
            wanderWords.forEach((_, i) => {
                const dot = document.createElement('div');
                dot.className = `progress-dot ${i === currentWanderIndex ? 'active' : ''}`;
                dot.addEventListener('click', () => {
                    currentWanderIndex = i;
                    refreshCardsVisibility();
                });
                wanderProgress.appendChild(dot);
            });
        }

        function updateLearnedCount() {
            if (!learnedCountElement) return;
            const marked = wanderWords.filter(w => {
                const h = wordHistory[w.key];
                return h && h.status !== WORD_STATUS.UNFAMILIAR;
            }).length;
            learnedCountElement.textContent = marked;
        }

        // ----- æ ‡è®°å•è¯çŠ¶æ€ -----
        function markWordAs(wordKey, status) {
            if (!wordHistory[wordKey]) {
                wordHistory[wordKey] = {
                    status: WORD_STATUS.UNFAMILIAR,
                    viewCount: 0,
                    lastViewed: null,
                    history: []
                };
            }
            wordHistory[wordKey].status = status;
            wordHistory[wordKey].lastViewed = new Date().toISOString();
            wordHistory[wordKey].history.push({
                status: status,
                timestamp: new Date().toISOString()
            });
            saveHistoryToStorage();
            showLearningStatus(`âœ… æ ‡è®°ä¸ºï¼š${getStatusText(status)}`);

            // å®æ—¶æ›´æ–°æ¼«æ¸¸å¡ç‰‡çŠ¶æ€
            if (currentMode === 'wander' || currentMode === 'collection') {
                const currentCard = document.querySelector(`.wander-card[data-wordkey="${wordKey}"]`);
                if (currentCard) {
                    const statusDiv = currentCard.querySelector('.mark-status');
                    if (statusDiv) {
                        statusDiv.className = `mark-status status-${status}`;
                        statusDiv.textContent = `å½“å‰çŠ¶æ€ï¼š${getStatusText(status)} (æŸ¥çœ‹ ${wordHistory[wordKey].viewCount || 0} æ¬¡)`;
                    }
                }
                updateLearnedCount();
            }
            if (currentMode === 'history') loadHistoryDisplay();
        }

        function recordWordView(wordKey) {
            if (!wordHistory[wordKey]) {
                wordHistory[wordKey] = {
                    status: WORD_STATUS.UNFAMILIAR,
                    viewCount: 0,
                    lastViewed: null,
                    history: []
                };
            }
            wordHistory[wordKey].viewCount = (wordHistory[wordKey].viewCount || 0) + 1;
            wordHistory[wordKey].lastViewed = new Date().toISOString();
            saveHistoryToStorage();
        }

        // ========== 13. å†å²è®°å½• å®Œæ•´UIä¸åŠŸèƒ½ ==========
        function loadHistoryDisplay(filter = 'all') {
            // æ¿€æ´»filteræŒ‰é’®
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });

            const stats = calculateHistoryStats();
            const statsGrid = document.getElementById('history-stats');
            if (statsGrid) {
                statsGrid.innerHTML = `<div class="history-stats-grid">
                                    <div class="history-stat"><div class="history-stat-value">${stats.total}</div><div class="history-stat-label">æ€»è¯</div></div>
                                    <div class="history-stat"><div class="history-stat-value">${stats.totalViews}</div><div class="history-stat-label">æŸ¥é˜…</div></div>
                                    <div class="history-stat"><div class="history-stat-value">${stats.unfamiliar}</div><div class="history-stat-label">é™Œç”Ÿ</div></div>
                                    <div class="history-stat"><div class="history-stat-value">${stats.somewhat}</div><div class="history-stat-label">æœ‰ç‚¹ç†Ÿ</div></div>
                                    <div class="history-stat"><div class="history-stat-value">${stats.familiar}</div><div class="history-stat-label">ç†Ÿæ‚‰</div></div>
                                    <div class="history-stat"><div class="history-stat-value">${stats.mastered}</div><div class="history-stat-label">æŒæ¡</div></div>
                                </div>`;
            }

            displayHistoryWords(filter);
        }

        function calculateHistoryStats() {
            const values = Object.values(wordHistory);
            return {
                total: values.length,
                unfamiliar: values.filter(h => h.status === WORD_STATUS.UNFAMILIAR).length,
                somewhat: values.filter(h => h.status === WORD_STATUS.SOMEWHAT).length,
                familiar: values.filter(h => h.status === WORD_STATUS.FAMILIAR).length,
                mastered: values.filter(h => h.status === WORD_STATUS.MASTERED).length,
                totalViews: values.reduce((acc, h) => acc + (h.viewCount || 0), 0)
            };
        }

        function displayHistoryWords(filter) {
            const container = document.getElementById('history-words-container');
            if (!container) return;
            container.innerHTML = '';

            let wordItems = [];
            vocabularyData.forEach(tb => {
                tb.units.forEach(unit => {
                    unit.vocabulary.forEach(word => {
                        const key = getWordKey(word, tb.name, unit.name);
                        if (wordHistory[key]) {
                            wordItems.push({
                                word,
                                textbook: tb.name,
                                unit: unit.name,
                                key,
                                history: wordHistory[key]
                            });
                        }
                    });
                });
            });

            if (filter !== 'all') {
                wordItems = wordItems.filter(item => item.history.status === filter);
            }

            wordItems.sort((a, b) => new Date(b.history.lastViewed) - new Date(a.history.lastViewed));

            if (wordItems.length === 0) {
                container.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:80px; background:white; border-radius:48px;">
                                    <i class="fas fa-inbox" style="font-size:4rem; color:var(--gray-color);"></i>
                                    <p style="margin-top:20px; font-size:1.3rem;">æš‚æ— è®°å½•</p>
                                </div>`;
                batchActions.style.display = 'none';
                return;
            }

            // æ˜¾ç¤ºæ‰¹é‡æ“ä½œæ 
            if (batchActions) batchActions.style.display = 'flex';
            updateSelectedCount();

            wordItems.forEach(item => {
                const card = document.createElement('div');
                card.className = `history-word-card ${item.history.status} ${selectedWords.has(item.key) ? 'selected' : ''}`;
                card.dataset.key = item.key;

                const pronBtn = `<button class="pronounce-btn" data-word="${item.word.word}"><i class="fas fa-volume-up"></i> å‘éŸ³</button>`;

                let detailsShort = '';
                if (item.word.details && item.word.details.length) {
                    detailsShort = item.word.details.slice(0, 2).join('ï¼›') + (item.word.details.length > 2 ? 'â€¦' : '');
                }

                card.innerHTML = `
                                    <div style="display:flex; align-items:center; justify-content:space-between;">
                                        <div style="display:flex; align-items:center; gap:10px;">
                                            <input type="checkbox" class="word-checkbox" data-key="${item.key}" ${selectedWords.has(item.key) ? 'checked' : ''} style="width:22px; height:22px;">
                                            <span class="history-word">${item.word.word}</span>
                                        </div>
                                        ${pronBtn}
                                    </div>
                                    <div style="display:flex; gap:12px; align-items:center; margin-top:6px;">
                                        <span class="history-status status-badge-${item.history.status}">${getStatusText(item.history.status)}</span>
                                        <span class="history-word-source">${item.textbook} Â· ${item.unit}</span>
                                    </div>
                                    <div class="history-word-meaning">${item.word.basic_meaning || ''}</div>
                                    ${detailsShort ? `<div class="history-word-details">${detailsShort}</div>` : ''}
                                    <div class="history-word-footer">
                                        <span class="history-view-count"><i class="fas fa-eye"></i> æŸ¥çœ‹ ${item.history.viewCount || 0} æ¬¡</span>
                                        <div>
                                            <button class="action-btn action-reset" data-key="${item.key}"><i class="fas fa-undo-alt"></i> é‡ç½®</button>
                                            <button class="action-btn action-delete" data-key="${item.key}"><i class="fas fa-trash"></i> åˆ é™¤</button>
                                        </div>
                                    </div>
                                `;

                // å‘éŸ³
                card.querySelector('.pronounce-btn')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    playPronunciation(item.word.word);
                });

                // å¤é€‰æ¡†å˜æ›´
                const cb = card.querySelector('.word-checkbox');
                if (cb) {
                    setupPronounceButton(card.querySelector('.pronounce-btn'), item.word.word); // è®¾ç½®æ”¹è¿›çš„å‘éŸ³æŒ‰é’®
                    cb.addEventListener('change', function (e) {
                        e.stopPropagation();
                        if (this.checked) {
                            selectedWords.add(item.key);
                            card.classList.add('selected');
                        } else {
                            selectedWords.delete(item.key);
                            card.classList.remove('selected');
                        }
                        updateSelectedCount();
                    });
                }

                // é‡ç½®æŒ‰é’®
                card.querySelector('.action-reset')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    resetWordHistory(item.key);
                });

                // åˆ é™¤æŒ‰é’®
                card.querySelector('.action-delete')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteWordHistory(item.key);
                });

                container.appendChild(card);
            });
        }

        function resetWordHistory(key) {
            if (wordHistory[key]) {
                wordHistory[key].status = WORD_STATUS.UNFAMILIAR;
                wordHistory[key].history.push({
                    status: WORD_STATUS.UNFAMILIAR,
                    timestamp: new Date().toISOString()
                });
                saveHistoryToStorage();
                loadHistoryDisplay();
                showLearningStatus('ğŸ”„ å·²é‡ç½®ä¸ºé™Œç”Ÿ');
            }
        }

        function deleteWordHistory(key) {
            if (confirm('ç¡®å®šåˆ é™¤è¯¥å•è¯çš„å†å²è®°å½•ï¼Ÿ')) {
                delete wordHistory[key];
                selectedWords.delete(key);
                saveHistoryToStorage();
                loadHistoryDisplay();
                showLearningStatus('ğŸ—‘ï¸ å·²åˆ é™¤');
            }
        }

        // æ‰¹é‡é€‰æ‹©
        function selectAllWords() {
            const allKeys = [];
            document.querySelectorAll('.history-word-card .word-checkbox').forEach(cb => {
                const key = cb.dataset.key;
                if (key) {
                    cb.checked = true;
                    selectedWords.add(key);
                    allKeys.push(key);
                }
            });
            document.querySelectorAll('.history-word-card').forEach(card => card.classList.add('selected'));
            updateSelectedCount();
        }

        function selectNoneWords() {
            document.querySelectorAll('.history-word-card .word-checkbox').forEach(cb => {
                cb.checked = false;
            });
            selectedWords.clear();
            document.querySelectorAll('.history-word-card').forEach(card => card.classList.remove('selected'));
            updateSelectedCount();
        }

        function batchDeleteWords() {
            if (selectedWords.size === 0) {
                showLearningStatus('è¯·å…ˆé€‰æ‹©å•è¯');
                return;
            }
            if (confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${selectedWords.size} ä¸ªå•è¯å†å²ï¼Ÿ`)) {
                selectedWords.forEach(key => {
                    delete wordHistory[key];
                });
                selectedWords.clear();
                saveHistoryToStorage();
                loadHistoryDisplay();
                showLearningStatus('âœ… æ‰¹é‡åˆ é™¤å®Œæˆ');
            }
        }

        function updateSelectedCount() {
            if (selectedCountSpan) {
                selectedCountSpan.textContent = `å·²é€‰æ‹© ${selectedWords.size} ä¸ªå•è¯`;
            }
        }

        // ========== 14. ç”Ÿè¯æœ¬å®Œæ•´åŠŸèƒ½ ==========
        function showCollectionWords() {
            const list = document.getElementById('collection-words-list');
            if (!list) return;
            list.innerHTML = '';

            let collectionWords = [];
            vocabularyData.forEach(tb => {
                tb.units.forEach(unit => {
                    unit.vocabulary.forEach(word => {
                        const key = getWordKey(word, tb.name, unit.name);
                        if (collectionSet.has(key)) {
                            collectionWords.push({
                                word,
                                textbook: tb.name,
                                unit: unit.name,
                                key
                            });
                        }
                    });
                });
            });

            document.getElementById('collection-count').textContent = collectionWords.length;

            if (collectionWords.length === 0) {
                list.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:70px; background:white; border-radius:48px;">
                                    <i class="fas fa-star" style="font-size:4rem; color:var(--collection-color); opacity:0.5;"></i>
                                    <p style="margin-top:20px; font-size:1.4rem;">ç”Ÿè¯æœ¬è¿˜æ˜¯ç©ºçš„ï¼Œå¿«å»æ·»åŠ å•è¯å§~</p>
                                </div>`;
                return;
            }

            collectionWords.forEach(item => {
                const card = document.createElement('div');
                card.className = 'history-word-card mastered';
                card.style.borderLeftColor = 'var(--collection-color)';
                card.innerHTML = `
                                    <div style="display:flex; justify-content:space-between; align-items:center;">
                                        <span class="history-word" style="color:var(--collection-color);">${item.word.word}</span>
                                        <button class="pronounce-btn" data-word="${item.word.word}"><i class="fas fa-volume-up"></i> å‘éŸ³</button>
                                    </div>
                                    <div class="history-word-source">${item.textbook} Â· ${item.unit}</div>
                                    <div class="history-word-meaning">${item.word.basic_meaning || ''}</div>
                                    <div style="margin-top:20px; display:flex; justify-content:flex-end;">
                                        <button class="action-btn remove-collection-btn" data-key="${item.key}" style="background:#fee2e2; color:#b91c1c;"><i class="fas fa-trash"></i> ç§»å‡ºç”Ÿè¯æœ¬</button>
                                    </div>
                                `;
                setupPronounceButton(card.querySelector('.pronounce-btn'), item.word.word); // è®¾ç½®æ”¹è¿›çš„å‘éŸ³æŒ‰é’®
                card.querySelector('.remove-collection-btn')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    collectionSet.delete(item.key);
                    saveCollectionToStorage();
                    showCollectionWords();
                    showLearningStatus('â– å·²ç§»å‡ºç”Ÿè¯æœ¬');
                });
                list.appendChild(card);
            });
        }

        function showAddCollectionModal() {
            document.getElementById('add-collection-modal').style.display = 'flex';
            switchCollectionTab('textbook');
            populateTextbookDropdown();
        }

        function switchCollectionTab(tab) {
            const textbookArea = document.getElementById('textbook-select-area');
            const historyArea = document.getElementById('history-select-area');
            const tabTextbook = document.getElementById('tab-textbook');
            const tabHistory = document.getElementById('tab-history');

            if (tab === 'textbook') {
                textbookArea.style.display = 'block';
                historyArea.style.display = 'none';
                tabTextbook.classList.add('active');
                tabHistory.classList.remove('active');
                populateTextbookDropdown();
            } else {
                textbookArea.style.display = 'none';
                historyArea.style.display = 'block';
                tabTextbook.classList.remove('active');
                tabHistory.classList.add('active');
                populateHistoryChecklist();
            }
        }

        function populateTextbookDropdown() {
            const select = document.getElementById('select-textbook');
            if (!select) return;
            select.innerHTML = '';
            vocabularyData.forEach((tb, index) => {
                const opt = document.createElement('option');
                opt.value = index;
                opt.textContent = tb.name;
                select.appendChild(opt);
            });
            populateUnitDropdown();
        }

        function populateUnitDropdown() {
            const tbIndex = document.getElementById('select-textbook').value;
            const unitSelect = document.getElementById('select-unit');
            if (!unitSelect) return;
            unitSelect.innerHTML = '';
            const textbook = vocabularyData[tbIndex];
            if (textbook) {
                textbook.units.forEach((unit, idx) => {
                    const opt = document.createElement('option');
                    opt.value = idx;
                    opt.textContent = unit.name;
                    unitSelect.appendChild(opt);
                });
            }
            populateWordCheckboxList();
        }

        function populateWordCheckboxList() {
            const container = document.getElementById('word-checkbox-list-container');
            if (!container) return;
            container.innerHTML = '';

            const tbIndex = document.getElementById('select-textbook').value;
            const unitIndex = document.getElementById('select-unit').value;
            if (tbIndex === undefined || unitIndex === undefined) return;

            const textbook = vocabularyData[tbIndex];
            if (!textbook) return;
            const unit = textbook.units[unitIndex];
            if (!unit) return;

            unit.vocabulary.forEach(word => {
                const key = getWordKey(word, textbook.name, unit.name);
                const div = document.createElement('div');
                div.className = 'word-check-item';
                div.innerHTML = `
                                    <input type="checkbox" id="cb_${key}" value="${key}" style="width:20px; height:20px;">
                                    <label for="cb_${key}">${word.word} â€” ${word.basic_meaning || ''}</label>
                                `;
                container.appendChild(div);
            });
        }

        function populateHistoryChecklist() {
            const container = document.getElementById('history-word-check-list');
            if (!container) return;
            container.innerHTML = '';

            const historyKeys = Object.keys(wordHistory);
            if (historyKeys.length === 0) {
                container.innerHTML = '<p style="padding:20px; color:gray;">æš‚æ— å†å²è®°å½•</p>';
                return;
            }

            historyKeys.forEach(key => {
                const div = document.createElement('div');
                div.className = 'word-check-item';
                div.innerHTML = `
                                    <input type="checkbox" id="hist_${key}" value="${key}" style="width:20px; height:20px;">
                                    <label for="hist_${key}">${key.split('|')[2] || key}</label>
                                `;
                container.appendChild(div);
            });
        }

        function addSelectedWordsToCollection() {
            const activeTab = document.getElementById('tab-textbook').classList.contains('active') ? 'textbook' : 'history';
            let addedCount = 0;

            if (activeTab === 'textbook') {
                const checkboxes = document.querySelectorAll('#word-checkbox-list-container input[type="checkbox"]:checked');
                checkboxes.forEach(cb => {
                    const key = cb.value;
                    if (!collectionSet.has(key)) {
                        collectionSet.add(key);
                        addedCount++;
                    }
                });
            } else {
                const checkboxes = document.querySelectorAll('#history-word-check-list input[type="checkbox"]:checked');
                checkboxes.forEach(cb => {
                    const key = cb.value;
                    if (!collectionSet.has(key)) {
                        collectionSet.add(key);
                        addedCount++;
                    }
                });
            }

            if (addedCount > 0) {
                saveCollectionToStorage();
                showLearningStatus(`âœ¨ å·²æ·»åŠ  ${addedCount} ä¸ªå•è¯åˆ°ç”Ÿè¯æœ¬`);
            } else {
                showLearningStatus('âš ï¸ æœªé€‰æ‹©ä»»ä½•æ–°å•è¯');
            }

            document.getElementById('add-collection-modal').style.display = 'none';
            if (currentMode === 'collection') showCollectionWords();
        }

        function startWanderFromCollection() {
            if (collectionSet.size === 0) {
                showLearningStatus('ç”Ÿè¯æœ¬ä¸ºç©ºï¼Œæ— æ³•æ¼«æ¸¸');
                return;
            }
            // åˆ‡æ¢åˆ°æ¼«æ¸¸æ¨¡å¼ï¼Œä½†æ ‡è®°å½“å‰æ¨¡å¼ä¸ºcollectionï¼Œä»¥ä¾¿generateåªå–ç”Ÿè¯æœ¬
            fromCollectionWander = true;
            currentMode = 'wander';
            modeSelection.style.display = 'none';
            unitModeDiv.style.display = 'none';
            wanderModeDiv.style.display = 'block';
            historyModeDiv.style.display = 'none';
            collectionModeDiv.style.display = 'none';
            if (shuffleBtn) shuffleBtn.style.display = 'none'; // éšè—éšæœºæ–°è¯æŒ‰é’®
            if (settingsBtn) settingsBtn.style.display = 'inline-flex'; // ç¡®ä¿è®¾ç½®æŒ‰é’®å¯è§
            if (document.getElementById('wander-title')) document.getElementById('wander-title').textContent = 'ğŸ“š ç”Ÿè¯æœ¬æ¼«æ¸¸';
            generateWanderWords();
        }

        // ========== 15. æ¼«æ¸¸è®¾ç½® ==========
        function showWanderSettings() {
            const modal = document.getElementById('wander-settings-modal');
            if (!modal) return;

            document.getElementById('prevent-recent').checked = wanderSettings.preventRecent;
            document.getElementById('wander-count-slider').value = wanderSettings.wanderCount;
            document.getElementById('wander-count-value').textContent = wanderSettings.wanderCount;
            document.getElementById('hide-chinese-checkbox').checked = wanderSettings.hideChinese;
            document.getElementById('hide-english-checkbox').checked = wanderSettings.hideEnglish;

            ['unfamiliar', 'somewhat', 'familiar', 'mastered'].forEach(s => {
                const slider = document.getElementById(`slider-${s}`);
                const label = document.getElementById(`weight-${s}`);
                if (slider) {
                    slider.value = wanderSettings.weights[s];
                    label.textContent = wanderSettings.weights[s];
                }
            });

            modal.style.display = 'flex';
        }

        function hideWanderSettings() {
            document.getElementById('wander-settings-modal').style.display = 'none';
        }

        function saveWanderSettings() {
            wanderSettings.preventRecent = document.getElementById('prevent-recent').checked;
            wanderSettings.wanderCount = parseInt(document.getElementById('wander-count-slider').value, 10);
            wanderSettings.hideChinese = document.getElementById('hide-chinese-checkbox').checked;
            wanderSettings.hideEnglish = document.getElementById('hide-english-checkbox').checked;

            ['unfamiliar', 'somewhat', 'familiar', 'mastered'].forEach(s => {
                const slider = document.getElementById(`slider-${s}`);
                if (slider) {
                    wanderSettings.weights[s] = parseInt(slider.value, 10);
                }
            });

            saveSettingsToStorage();
            hideWanderSettings();

            if (currentMode === 'wander' || currentMode === 'collection') {
                generateWanderWords();
            }
            showLearningStatus('âš™ï¸ è®¾ç½®å·²ä¿å­˜');
        }

        // ========== 16. é‡ç½®é€‰æ‹© ==========
        function resetSelection() {
            selectedWords.clear();
        }

        console.log('âœ… ç¬¬ä¸€éƒ¨åˆ†JSåŠ è½½å®Œæˆï¼Œæ‰€æœ‰åŠŸèƒ½å°±ç»ª');
    </script>
</body>
</html>